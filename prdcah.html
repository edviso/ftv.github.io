<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Predicci√≥n de Amperios (PV) ‚Äî v1.6.1</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#2563eb;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --cool:#1e3a8a;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--text)}
  header{padding:16px 14px 8px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  h1{font-size:18px; margin:0}
  .subtitle{color:var(--muted); font-size:13px; flex:1 1 100%}
  .header-actions{margin-left:auto}
  .wrap{padding:10px 14px 24px}
  .card{background:var(--card); border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,.04); padding:14px; margin:12px 0; overflow:hidden}
  .row{display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; margin:10px 0}
  .row > :last-child{min-width:0}
  .label{font-size:14px}
  .hint{font-size:12px; color:var(--muted)}
  .step{display:grid; grid-template-columns:38px 96px 38px; align-items:center; gap:6px}
  .step button{height:38px; border:none; border-radius:12px; background:#eef2ff; font-size:18px; cursor:pointer}
  .step input{height:38px; text-align:center; border:1px solid #e5e7eb; border-radius:12px; font-size:15px; padding:0 6px}
  input[type="time"], input[type="date"], input[type="number"], input[type="text"]{
    border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; font-size:15px; background:#fff;
    width:100%; max-width:100%;
  }
  .grid2{display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:10px}
  .grid3{display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap:8px}
  .btn{display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:12px 16px; border:none; border-radius:14px; background:var(--accent); color:#fff; font-weight:600; font-size:16px; cursor:pointer}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#eef2ff; color:#111827}
  .btn.sm{padding:8px 12px; font-size:13px; border-radius:10px}
  .btn:active{transform:scale(0.98)}
  .out{display:grid; gap:10px}
  .kpi{display:grid; grid-template-columns:1fr auto; align-items:end; padding:12px; border-radius:14px; background:#f3f4f6}
  .kpi .value{font-size:28px; font-weight:800}
  .kpi .range{font-size:13px; color:var(--muted)}
  .badge{padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; color:#fff}
  .badge.red{background:var(--bad)}
  .badge.orange{background:var(--warn)}
  .badge.green{background:var(--ok)}
  .badge.blue{background:var(--cool)}
  details textarea{width:100%; min-height:140px; padding:10px; border-radius:12px; border:1px solid #e5e7eb}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap; overflow-wrap:anywhere}
  .page-bottom{display:flex; justify-content:flex-end; padding:10px 0}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.7)}100%{box-shadow:0 0 0 12px rgba(37,99,235,0)}}
  .flash{animation:flash .5s ease}

  /* ===== Proyecci√≥n semanal ===== */
  .week-title{margin:2px 0 10px}
  .week-scroll{display:flex; gap:10px; overflow-x:auto; padding-bottom:2px}
  .wcell{
    flex:0 0 86px; height:86px; background:#000; color:#fff;
    border-radius:22px; display:flex; flex-direction:column;
    align-items:center; justify-content:center; position:relative;
  }
  .w-date{position:absolute; top:8px; left:10px; font-size:13px; opacity:.9}
  .w-day{font-size:13px; letter-spacing:.2px; margin-top:2px}
  .w-val{font-size:28px; font-weight:800; line-height:1; margin-top:2px}
</style>
</head>
<body>
  <header>
    <h1>Predicci√≥n de Amperios (PV)</h1>
    <div class="subtitle">Modelo con p√©rdidas, ventana de sol directo y clima Open-Meteo ¬∑ <b>v1.6.1</b></div>
    <div class="header-actions">
      <button class="btn ghost sm" id="btnCopyHtml" type="button">üìã Copiar HTML</button>
      <button class="btn ghost sm" id="btnDownload" type="button">‚¨áÔ∏è Descargar</button>
    </div>
  </header>
  <div class="wrap">

    <!-- ===== Par√°metros ===== -->
    <div class="card">
      <div class="row">
        <div class="label"><b>Fecha</b></div>
        <div class="grid3">
          <input id="fecha" type="date">
          <button class="btn ghost sm" id="btnHoy" type="button">Hoy</button>
          <button class="btn ghost sm" id="btnMas1" type="button">+1 d√≠a</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Latitud / Longitud</div>
        <div class="grid2">
          <input id="lat" type="number" inputmode="decimal" step="0.0001">
          <input id="lon" type="number" inputmode="decimal" step="0.0001">
        </div>
      </div>
      <div class="row">
        <div class="label">Voltaje medio del banco (V)</div>
        <div class="step" data-id="vbank" data-step="0.1" data-min="10" data-max="16">
          <button class="btn-step" data-delta="-0.1" type="button">‚àí</button>
          <input id="vbank" type="number" inputmode="decimal" step="0.1">
          <button class="btn-step" data-delta="0.1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Eficiencia base del arreglo (%)</div>
        <div class="step" data-id="effBase" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="effBase" type="number" inputmode="numeric">
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Cielo visible (0‚Äì1)</div>
        <div class="step" data-id="cieloVis" data-step="0.01" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.01" type="button">‚àí</button>
          <input id="cieloVis" type="number" inputmode="decimal" step="0.01">
          <button class="btn-step" data-delta="0.01" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Factor difuso <b>fuera</b> de ventana (0‚Äì1)</div>
        <div class="step" data-id="kDif" data-step="0.05" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.05" type="button">‚àí</button>
          <input id="kDif" type="number" inputmode="decimal" step="0.01">
          <button class="btn-step" data-delta="0.05" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Factor difuso <b>dentro</b> de ventana (0‚Äì1)</div>
        <div class="step" data-id="kDifIn" data-step="0.05" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.05" type="button">‚àí</button>
          <input id="kDifIn" type="number" inputmode="decimal" step="0.01">
          <button class="btn-step" data-delta="0.05" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Sol directo</div>
        <div class="grid2">
          <input id="hIni" type="time">
          <input id="hFin" type="time">
        </div>
      </div>
    </div>

    <!-- ===== P√©rdidas ===== -->
    <div class="card">
      <h3 style="margin:2px 0 8px">P√©rdidas del sistema</h3>
      <div class="row">
        <div class="label">El√©ctrica (%)</div>
        <div class="step" data-id="pElec" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pElec" type="number" inputmode="numeric">
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Suciedad (%)</div>
        <div class="step" data-id="pDirt" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pDirt" type="number" inputmode="numeric">
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">MPPT (%)</div>
        <div class="step" data-id="pMppt" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pMppt" type="number" inputmode="numeric">
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">√Ångulo (%)</div>
        <div class="step" data-id="pAng" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pAng" type="number" inputmode="numeric">
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="hint">Todos los porcentajes se aplican como multiplicadores (p/100).</div>
    </div>

    <!-- ===== Acciones ===== -->
    <div class="card">
      <div class="grid2">
        <button class="btn" id="btnCalc" type="button">üîÑ Recalcular con Open-Meteo</button>
        <button class="btn secondary" id="btnGuardar" type="button">üíæ Guardar como predeterminado</button>
      </div>

      <!-- Microclima -->
      <div class="row" style="margin-top:8px">
        <div class="label">Microclima (5 puntos)</div>
        <div class="grid2">
          <label class="hint" style="display:flex;align-items:center;gap:8px">
            <input id="useMicro" type="checkbox"> Activar
          </label>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <span class="hint">Œ¥ (¬∞)</span>
            <input id="delta" type="number" inputmode="decimal" step="0.01" min="0.01" max="0.05" style="width:100px">
          </div>
        </div>
      </div>
      <div class="hint">Œ¥=0.02 ‚âà 2.2 km. Calcula Centro, N, S, E, O y muestra rango microclima.</div>

      <details style="margin-top:10px">
        <summary class="hint">Alternativa: pegar JSON manual (estructura Open-Meteo o la tuya en espa√±ol)</summary>
        <textarea id="jsonManual" placeholder="Pega aqu√≠ el JSON y pulsa ‚ÄòCalcular con JSON‚Äô"></textarea>
        <div class="grid2" style="margin-top:8px">
          <button class="btn ghost sm" id="btnCalcJson" type="button">Calcular con JSON</button>
          <button class="btn ghost sm" id="btnLimpiarJson" type="button">Limpiar</button>
        </div>
      </details>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost sm" id="btnDiag" type="button">ü©∫ Diagn√≥stico</button>
      </div>
    </div>

    <!-- ===== Proyecci√≥n Semanal ===== -->
    <div class="card" id="weeklyCard" hidden>
      <h3 class="week-title">Proyecci√≥n Semanal</h3>
      <div class="week-scroll" id="weekGrid"></div>
      <div class="hint" style="margin-top:6px">Valores estimados de Ah por d√≠a (Open-Meteo, mismo modelo de p√©rdidas).</div>
    </div>

    <!-- ===== Salida principal ===== -->
    <div class="card out" id="panelOut" hidden>
      <div class="kpi">
        <div>
          <div class="hint">Amperios previstos (12√ó60 W, 6 bater√≠as)</div>
          <div class="value" id="ahValue">‚Äî</div>
          <div class="range" id="ahRange">‚Äî</div>
        </div>
        <div><span class="badge" id="badgeUso">‚Äî</span></div>
      </div>
      <div class="grid2">
        <div class="card" style="padding:10px">
          <div class="hint">Resumen t√©cnico</div>
          <pre class="mono" id="resume" style="margin:0"></pre>
        </div>
        <div class="card" style="padding:10px">
          <div class="hint">Sol, variabilidad y microclima</div>
          <pre class="mono" id="sunInfo" style="margin:0"></pre>
        </div>
      </div>
      <div class="page-bottom">
        <button class="btn ghost sm" id="btnCalc3" type="button">Recalcular</button>
      </div>
    </div>

  </div>

<script>
(function(){
  const APP_VERSION = "1.6.1";
  const STORAGE_KEY = "pvPredictDefaults_v1_6_1";

  const $ = sel => document.querySelector(sel);
  const fmt = n => n.toLocaleString('es-EC',{maximumFractionDigits:0});
  const f2  = n => n.toLocaleString('es-EC',{maximumFractionDigits:2});

  const defaults = {
    fecha: todayStr(0),
    lat: -2.125, lon: -79.875,
    vbank: 13.0, effBase: 75,
    cieloVis: 0.65, kDif: 0.25, kDifIn: 0.35,
    hIni: '09:00', hFin: '14:00',
    pElec: 90, pDirt: 94, pMppt: 85, pAng: 93,
    useMicro:false, delta:0.02
  };

  function todayStr(shiftDays){ const d=new Date(); d.setDate(d.getDate()+(shiftDays||0)); return d.toISOString().slice(0,10); }

  function safeMerge(def, saved){
    const out={...def}; for(const k in (saved||{})){ const v=saved[k];
      if(['fecha','hIni','hFin'].includes(k)){ if(typeof v==='string'&&v) out[k]=v; }
      else if(typeof v==='boolean') out[k]=v;
      else if(typeof v==='number' && Number.isFinite(v)) out[k]=v;
    } return out;
  }
  function loadSaved(){
    try{ const raw=localStorage.getItem(STORAGE_KEY); return safeMerge(defaults, raw?JSON.parse(raw):{}); }
    catch{ localStorage.removeItem(STORAGE_KEY); return {...defaults}; }
  }
  const state=loadSaved();

  const setVal=(id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
  const setCheck=(id,val)=>{ const el=document.getElementById(id); if(el) el.checked=!!val; };

  setVal('fecha',state.fecha); setVal('lat',state.lat); setVal('lon',state.lon);
  setVal('vbank',state.vbank); setVal('effBase',state.effBase);
  setVal('cieloVis',state.cieloVis); setVal('kDif',state.kDif); setVal('kDifIn',state.kDifIn);
  setVal('hIni',state.hIni); setVal('hFin',state.hFin);
  setVal('pElec',state.pElec); setVal('pDirt',state.pDirt); setVal('pMppt',state.pMppt); setVal('pAng',state.pAng);
  setCheck('useMicro',state.useMicro); setVal('delta',state.delta);

  $('#btnHoy').onclick = ()=> setVal('fecha', todayStr(0));
  $('#btnMas1').onclick = ()=> setVal('fecha', todayStr(1));

  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.btn-step'); if(!btn) return;
    const stepEl=btn.parentElement; const input=stepEl.querySelector('input');
    const min=+stepEl.dataset.min, max=+stepEl.dataset.max, step=+stepEl.dataset.step, delta=+btn.dataset.delta;
    let v=(+input.value||0)+delta; v=Math.min(max,Math.max(min,v)); v=Math.round(v/step)*step;
    input.value=(step%1!==0)?v.toFixed(2):String(v);
  });
  document.querySelectorAll('.step input').forEach(el=>{
    el.addEventListener('input',()=>{
      const stepEl=el.parentElement; let v=parseFloat(el.value); if(isNaN(v)) return;
      const min=+stepEl.dataset.min, max=+stepEl.dataset.max, step=+stepEl.dataset.step;
      v=Math.min(max,Math.max(min,v)); v=Math.round(v/step)*step; el.value=(step%1!==0)?v.toFixed(2):String(v);
    });
  });

  $('#btnCalc').onclick = mainRun; $('#btnCalc3').onclick = mainRun;
  $('#btnGuardar').onclick = ()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(readInputs())); toast('Valores guardados como predeterminados.'); };
  $('#btnDiag').onclick = selfTest;

  const btnCopy=$('#btnCopyHtml');
  if(btnCopy){ btnCopy.onclick=async()=>{ try{ const html='<!DOCTYPE html>\\n'+document.documentElement.outerHTML; await navigator.clipboard.writeText(html); flash(btnCopy,'¬°Copiado!'); }catch(e){ toast('No se pudo copiar: '+e.message); } }; }
  const btnDownload=$('#btnDownload');
  if(btnDownload){ btnDownload.onclick=()=>{ const blob=new Blob(['<!DOCTYPE html>\\n'+document.documentElement.outerHTML],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_prediccion_ah_v1_6_1.html'; a.click(); URL.revokeObjectURL(a.href); }; }

  $('#btnCalcJson').onclick = ()=>{ const txt=$('#jsonManual').value.trim(); if(!txt){ toast('Pega un JSON v√°lido.'); return; }
    try{ const obj=JSON.parse(txt); const parsed=parseAnyJson(obj); if(!parsed){ toast('No pude interpretar ese JSON.'); return; }
      const res=computeAh(parsed, readInputs()); paintSingle(res); buildWeekCells(); paintWeekPlaceholders();
    }catch(e){ toast('JSON inv√°lido: '+e.message); } };
  $('#btnLimpiarJson').onclick=()=>$('#jsonManual').value='';

  function readInputs(){
    return {
      fecha: $('#fecha').value,
      lat:+$('#lat').value, lon:+$('#lon').value,
      vbank:+$('#vbank').value, effBase:+$('#effBase').value,
      cieloVis:+$('#cieloVis').value, kDif:+$('#kDif').value, kDifIn:+$('#kDifIn').value,
      hIni:$('#hIni').value, hFin:$('#hFin').value,
      pElec:+$('#pElec').value, pDirt:+$('#pDirt').value, pMppt:+$('#pMppt').value, pAng:+$('#pAng').value,
      useMicro:$('#useMicro').checked, delta:+$('#delta').value||0.02
    };
  }

  async function mainRun(){
    const p=readInputs(); if(p.hIni>=p.hFin){ toast('La hora de inicio debe ser menor que la de fin.'); return; }
    if(p.useMicro){ await run5(p); } else { await run1(p); }
    await runWeek(p); // siempre llena la tarjeta semanal empezando en p.fecha
  }

  async function run1(p){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Guayaquil';
    const url = buildOMUrl(p.lat, p.lon, p.fecha, tz);
    try{
      const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); const series=parseOpenMeteo(data);
      const out=computeAh(series,p); paintSingle(out);
    }catch(e){ toast('Fallo Open-Meteo: '+e.message); }
  }

  async function run5(p){
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Guayaquil';
    const Œ¥ = clamp(p.delta,0.01,0.05);
    const pts=[{name:'Centro',lat:p.lat,lon:p.lon},{name:'N',lat:p.lat+Œ¥,lon:p.lon},{name:'S',lat:p.lat-Œ¥,lon:p.lon},{name:'E',lat:p.lat,lon:p.lon+Œ¥},{name:'O',lat:p.lat,lon:p.lon-Œ¥}];
    const urls=pts.map(pt=>buildOMUrl(pt.lat,pt.lon,p.fecha,tz));
    try{
      const reqs=urls.map(u=>fetch(u).then(r=>r.ok?r.json():Promise.reject(new Error('HTTP '+r.status))));
      const all=await Promise.allSettled(reqs); const results=[];
      for(let i=0;i<all.length;i++){ if(all[i].status==='fulfilled'){ const ser=parseOpenMeteo(all[i].value); const out=computeAh(ser,p); results.push({name:pts[i].name,...out}); } }
      if(!results.length){ toast('No se pudo obtener datos de microclima.'); return; }
      paintMicro(results);
    }catch(e){ toast('Fallo Open-Meteo (microclima): '+e.message); }
  }

  /* ===== Proyecci√≥n semanal (empieza en p.fecha) ===== */
  function buildOMUrlWeek(lat, lon, startDate, days, tz){
    const d=new Date(startDate); const end=new Date(d); end.setDate(d.getDate()+(days-1));
    const url=new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude',lat); url.searchParams.set('longitude',lon); url.searchParams.set('timezone',tz);
    url.searchParams.set('start_date',startDate); url.searchParams.set('end_date', end.toISOString().slice(0,10));
    url.searchParams.set('hourly','cloud_cover,temperature_2m,relative_humidity_2m,precipitation_probability,wind_speed_10m');
    url.searchParams.set('daily','sunrise,sunset');
    return url.toString();
  }
  function parseOpenMeteoRange(data){
    const times=data?.hourly?.time||[], cloud=data?.hourly?.cloud_cover||[];
    const sunr=data?.daily?.sunrise||[], suns=data?.daily?.sunset||[];
    return {times, cloud, sunr, suns};
  }

  async function runWeek(p){
    buildWeekCells(); // crea estructura si falta
    paintWeekPlaceholders();

    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Guayaquil';
    const url = buildOMUrlWeek(p.lat, p.lon, p.fecha, 7, tz);
    try{
      const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json(); const parsed=parseOpenMeteoRange(data);

      // Agrupar por d√≠a
      const byDate={};
      for(let i=0;i<parsed.times.length;i++){
        const key=parsed.times[i].slice(0,10);
        (byDate[key] ||= {times:[],cloud:[]});
        byDate[key].times.push(parsed.times[i]);
        byDate[key].cloud.push(parsed.cloud[i]);
      }

      const values=[], labels=[], dates=[];
      for(let k=0;k<7;k++){
        const d=new Date(p.fecha); d.setDate(d.getDate()+k);
        const key=d.toISOString().slice(0,10);
        const sunrise=parsed.sunr?.[k] || (key+'T06:00');
        const sunset =parsed.suns?.[k] || (key+'T18:00');
        const seriesDay={ times:(byDate[key]?.times)||[], cloud:(byDate[key]?.cloud)||[], sunrise, sunset };
        const out=computeAh(seriesDay,p);
        values.push(isFinite(out?.Ah)? Math.max(0, Math.round(out.Ah)) : null);
        labels.push(getDowShort(d)); dates.push(String(d.getDate()).padStart(2,'0'));
      }
      paintWeek(values, labels, dates);
    }catch(e){ toast('Fallo Proyecci√≥n semanal: '+e.message); }
  }

  function getDowShort(date){
    // ES: 0=Dom ‚Ä¶ 6=S√°b
    const d = date.getDay();
    return ['Dom','Lun','Mar','Mier','Jue','Vie','S√°b'][d];
  }

  function buildWeekCells(){
    const grid=$('#weekGrid'); if(!grid) return;
    if(grid.children.length) return;
    for(let i=0;i<7;i++){
      const cell=document.createElement('div'); cell.className='wcell';
      const dateSmall=document.createElement('div'); dateSmall.className='w-date'; dateSmall.id='wdate'+i; dateSmall.textContent='‚Äî';
      const lab=document.createElement('div'); lab.className='w-day'; lab.id='wday'+i; lab.textContent='‚Äî';
      const val=document.createElement('div'); val.className='w-val'; val.id='wval'+i; val.textContent='‚Äî';
      cell.appendChild(dateSmall); cell.appendChild(lab); cell.appendChild(val);
      grid.appendChild(cell);
    }
    $('#weeklyCard').hidden=false;
  }
  function paintWeekPlaceholders(){
    for(let i=0;i<7;i++){ const v=$('#wval'+i), d=$('#wday'+i), s=$('#wdate'+i); if(v) v.textContent='‚Äî'; if(d) d.textContent='‚Äî'; if(s) s.textContent='‚Äî'; }
    $('#weeklyCard').hidden=false;
  }
  function paintWeek(vals, labels, dates){
    for(let i=0;i<7;i++){
      const vEl=$('#wval'+i), dEl=$('#wday'+i), sEl=$('#wdate'+i);
      if(vEl) vEl.textContent = (vals?.[i]==null)?'‚Äî':vals[i].toString();
      if(dEl && labels) dEl.textContent = labels[i]||'‚Äî';
      if(sEl && dates)  sEl.textContent = dates[i]||'‚Äî';
    }
    $('#weeklyCard').hidden=false;
  }

  /* ===== API por d√≠a (existente) ===== */
  function buildOMUrl(lat, lon, fecha, tz){
    const url=new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude',lat); url.searchParams.set('longitude',lon); url.searchParams.set('timezone',tz);
    url.searchParams.set('start_date',fecha); url.searchParams.set('end_date',fecha);
    url.searchParams.set('hourly','cloud_cover,temperature_2m,relative_humidity_2m,precipitation_probability,wind_speed_10m');
    url.searchParams.set('daily','sunrise,sunset');
    return url.toString();
  }
  function parseOpenMeteo(data){ const times=data?.hourly?.time||[]; const cloud=data?.hourly?.cloud_cover||[]; const sunrise=data?.daily?.sunrise?.[0]||null; const sunset=data?.daily?.sunset?.[0]||null; return {times,cloud,sunrise,sunset}; }
  function parseAnyJson(obj){
    if(obj?.hourly?.time && (obj?.hourly?.cloud_cover||obj?.hourly?.nubes)){
      const cloud=obj.hourly.cloud_cover||obj.hourly.nubes; const sunrise=obj?.daily?.sunrise?.[0]||null; const sunset=obj?.daily?.sunset?.[0]||null; return {times:obj.hourly.time, cloud, sunrise, sunset};
    }
    const ch=obj['cada hora']||obj['cada_hora']||obj['cadaHora'];
    if(ch&&(ch['nubes']||ch['nubosidad'])&&ch['tiempo']){
      const sunrise=obj?.diario?.amanecer||obj?.daily?.sunrise?.[0]||null; const sunset=obj?.diario?.atardecer||obj?.daily?.sunset?.[0]||null;
      return {times:ch['tiempo'], cloud:ch['nubes']||ch['nubosidad'], sunrise, sunset};
    }
    return null;
  }

  /* ===== N√∫cleo c√°lculo ===== */
  function computeAh(series,p){
    const {times,cloud}=series; if(!times?.length||!cloud?.length){ return {error:'Serie horaria incompleta.'}; }
    const sunrise=series.sunrise?new Date(series.sunrise):new Date(p.fecha+'T06:00');
    const sunset =series.sunset ?new Date(series.sunset) :new Date(p.fecha+'T18:00');
    const hIni=toHM(p.hIni), hFin=toHM(p.hFin);
    const P_nom=12*60;
    const P_eff=P_nom*(p.effBase/100)*(p.pElec/100)*(p.pDirt/100)*(p.pMppt/100)*(p.pAng/100);
    let HSE=0; const cloudsDay=[];
    for(let i=0;i<times.length;i++){
      const t=new Date(times[i]); if(!(t>=sunrise&&t<sunset)) continue;
      const h=t.getHours(); const inside=(h>=hIni.h && h<hFin.h);
      const cc=clamp(cloud[i],0,100); const c=cc/100; const clear=1-c; const base=inside?1.0:(p.kDif||0.25);
      const fEff=((clear)+(c*(p.kDifIn||0.35)))*(p.cieloVis||0.65)*base;
      HSE+=fEff; cloudsDay.push(cc);
    }
    if(HSE===0){ for(let i=0;i<times.length;i++){ const cc=clamp(cloud[i],0,100); const c=cc/100; const clear=1-c; const fEff=((clear)+(c*(p.kDifIn||0.35)))*(p.cieloVis||0.65)*(p.kDif||0.25); HSE+=fEff; cloudsDay.push(cc);} }
    const Wh=P_eff*HSE; const Ah=Wh/p.vbank; const sigma=stddev(cloudsDay);
    const bandPct=0.10+0.2*(sigma/100);
    const AhLow=Ah*(1-bandPct), AhHigh=Ah*(1+bandPct);
    return {Ah, AhLow, AhHigh, Wh, HSE, P_nom, P_eff, sigma, bandPct, sunrise, sunset, p};
  }

  /* ===== Pintado ===== */
  function paintSingle(out){
    if(out?.error){ toast(out.error); return; }
    $('#panelOut').hidden=false;
    $('#ahValue').textContent=`${fmt(out.Ah)} Ah`;
    $('#ahRange').textContent=`Rango: ${fmt(out.AhLow)} ‚Äì ${fmt(out.AhHigh)} Ah (¬± ${(out.bandPct*100).toFixed(1)}%)`;
    const uso=usoRecomendado(out.Ah); const badge=$('#badgeUso'); badge.textContent=uso.text; badge.className='badge '+uso.cl;
    $('#resume').textContent=`P_nom = 12√ó60 W = ${out.P_nom} W\nP_eff = ${f2(out.P_eff)} W\nHSE = ${f2(out.HSE)} h\nEnerg√≠a = ${fmt(out.Wh)} Wh\nVoltaje banco = ${out.p.vbank.toFixed(1)} V\nAmperios = ${fmt(out.Ah)} Ah`;
    const sr=fmtHM(out.sunrise), ss=fmtHM(out.sunset);
    $('#sunInfo').textContent=`Amanecer: ${sr}  ¬∑  Atardecer: ${ss}\nVentana directo: ${out.p.hIni}‚Äì${out.p.hFin}\nCielo visible: ${out.p.cieloVis}  ¬∑  Difuso ext: ${out.p.kDif}  ¬∑  Difuso int: ${out.p.kDifIn}\nœÉ(nubosidad d√≠a) = ${out.sigma.toFixed(1)} pts`;
  }
  function paintMicro(list){
    const centro=list.find(r=>r.name==='Centro')||list[0];
    const AhVals=list.map(r=>r.Ah);
    const Ah_min=Math.min(...AhVals), Ah_max=Math.max(...AhVals);
    const low_cons=Math.min(...list.map(r=>r.AhLow));
    const hi_cons =Math.max(...list.map(r=>r.AhHigh));
    paintSingle(centro);
    const extra=`\nMicroclima (5 ptos): ${fmt(Ah_min)} ‚Äì ${fmt(Ah_max)} Ah\nConservador: ${fmt(low_cons)} ‚Äì ${fmt(hi_cons)} Ah`;
    $('#sunInfo').textContent = ($('#sunInfo').textContent||'') + extra;
  }

  /* ===== Utilidades ===== */
  function usoRecomendado(Ah){ if(Ah<=47) return {text:'Ahorro', cl:'red'}; if(Ah<=53) return {text:'Normal', cl:'green'}; return {text:'Holgado', cl:'blue'}; }
  function clamp(x,min,max){ return Math.min(max, Math.max(min,x)); }
  function toHM(str){ const [h,m]=str.split(':').map(x=>parseInt(x,10)); return {h:(isNaN(h)?0:h), m:(isNaN(m)?0:m)}; }
  function stddev(arr){ if(!arr.length) return 0; const m=arr.reduce((a,b)=>a+b,0)/arr.length; const v=arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length; return Math.sqrt(v); }
  function fmtHM(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
  function toast(msg){ const n=document.createElement('div'); n.textContent=msg; n.style.position='fixed'; n.style.left='50%'; n.style.bottom='90px'; n.style.transform='translateX(-50%)'; n.style.background='#111827'; n.style.color='#fff'; n.style.padding='10px 14px'; n.style.borderRadius='12px'; n.style.fontSize='14px'; n.style.boxShadow='0 8px 20px rgba(0,0,0,.2)'; document.body.appendChild(n); setTimeout(()=>n.remove(),1600); }
  function flash(btn, okText){ const old=btn.textContent; btn.textContent='‚úî '+okText; btn.classList.add('flash'); setTimeout(()=>{btn.textContent=old; btn.classList.remove('flash');},1100); }

  function selfTest(){
    const ids=['fecha','lat','lon','vbank','effBase','cieloVis','kDif','kDifIn','hIni','hFin','pElec','pDirt','pMppt','pAng','btnCalc','btnGuardar'];
    const missing=ids.filter(id=>!document.getElementById(id)); if(missing.length){ toast('Diagn√≥stico: faltan elementos '+missing.join(', ')); return; }
    try{
      const fake={times:Array.from({length:12},(_,i)=>`2025-01-01T0${i+6}:00`), cloud:Array(12).fill(40), sunrise:'2025-01-01T06:00', sunset:'2025-01-01T18:00'};
      const out=computeAh(fake, readInputs()); if(!out || !isFinite(out.Ah)) throw new Error('c√°lculo inv√°lido');
      buildWeekCells(); paintWeekPlaceholders();
      toast('Diagn√≥stico OK ¬∑ v'+APP_VERSION);
    }catch(e){ toast('Diagn√≥stico fall√≥: '+e.message); }
  }
  setTimeout(selfTest,50);

})();
</script>

</body></html>