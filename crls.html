<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acuarela - Retrato por Capas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f0;
            padding: 16px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: #3a3a3a;
            margin-bottom: 16px;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .container {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding-bottom: 20px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            height: 100%;
        }

        .card {
            min-width: 280px;
            max-width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            scroll-snap-align: start;
            flex-shrink: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 16px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            background: #fafafa;
            margin-bottom: 12px;
        }

        .image-upload-container {
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 8px;
            display: none;
            background: #f9f9f9;
        }

        .image-preview.show {
            display: block;
        }

        .upload-btn {
            width: 100%;
            padding: 10px;
            background: #e0e0e0;
            border: 2px dashed #999;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            color: #555;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: #d0d0d0;
            border-color: #777;
        }

        .remove-image {
            width: 100%;
            padding: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .remove-image.show {
            display: block;
        }

        .remove-image:active {
            background: #c0392b;
        }

        textarea:focus {
            outline: none;
            border-color: #888;
            background: white;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-shrink: 0;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #4a90e2;
            color: white;
        }

        .btn-save:active {
            background: #357abd;
        }

        .btn-export {
            background: #5cb85c;
            color: white;
        }

        .btn-export:active {
            background: #449d44;
        }

        .btn-import {
            background: #f0ad4e;
            color: white;
        }

        .btn-import:active {
            background: #ec971f;
        }

        input[type="file"] {
            display: none;
        }

        /* Colores para cada capa */
        .layer-1 { background: linear-gradient(135deg, #6b7a9e, #4d5f85); }
        .layer-2 { background: linear-gradient(135deg, #f4d5b5, #e8c4a0); }
        .layer-3 { background: linear-gradient(135deg, #c8a882, #b89968); }
        .layer-4 { background: linear-gradient(135deg, #d9b899, #c9a885); }
        .layer-5 { background: linear-gradient(135deg, #e8b4a0, #d99f88); }
        .layer-6 { background: linear-gradient(135deg, #9eb3b8, #8a9fa4); }
        .layer-7 { background: linear-gradient(135deg, #f5e5d5, #e8d5c0); }
        .layer-8 { background: linear-gradient(135deg, #f8ebe0, #ecddc8); }
        .layer-9 { background: linear-gradient(135deg, #d88b8b, #c47a7a); }
        .layer-10 { background: linear-gradient(135deg, #ffffff, #f0f0f0); color: #333 !important; }
        .layer-11 { background: linear-gradient(135deg, #8b6f47, #6f5a3a); }
        .layer-12 { background: linear-gradient(135deg, #b8a090, #a08f7f); }
        .layer-palette { background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3); }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1>Acuarela — Retrato por Capas</h1>
    
    <div class="container" id="container"></div>
    
    <div class="notification" id="notification"></div>

    <script>
        const layers = [
            { id: 1, title: "Capa 1 — Fondo suave (té)", class: "layer-1" },
            { id: 2, title: "Capa 2 — Base de piel (té)", class: "layer-2" },
            { id: 3, title: "Capa 3 — Primer modelado de sombras (leche)", class: "layer-3" },
            { id: 4, title: "Capa 4 — Sombras cálidas (leche-media)", class: "layer-4" },
            { id: 5, title: "Capa 5 — Rubor y pómulos (leche)", class: "layer-5" },
            { id: 6, title: "Capa 6 — Enfriamiento de sombras (leche)", class: "layer-6" },
            { id: 7, title: "Capa 7 — Segunda profundidad en piel (crema)", class: "layer-7" },
            { id: 8, title: "Capa 8 — Detalles finos del rostro (crema)", class: "layer-8" },
            { id: 9, title: "Capa 9 — Labios naturales (crema)", class: "layer-9" },
            { id: 10, title: "Capa 10 — Toques de luz (agua limpia / reserva)", class: "layer-10" },
            { id: 11, title: "Capa 11 — Cabello (té a leche según zona)", class: "layer-11" },
            { id: 12, title: "Capa 12 — Fondo y ropa (leche a crema, finalización)", class: "layer-12" },
            { id: 'palette', title: "Paleta de colores", class: "layer-palette", isPalette: true }
        ];

        let layerData = {};

        // Inicializar datos vacíos
        layers.forEach(layer => {
            if (layer.isPalette) {
                layerData[layer.id] = {
                    description: "",
                    paletaAcuarela: null,
                    paletaRetratos: null,
                    paletaVariantes: null
                };
            } else {
                layerData[layer.id] = {
                    description: "",
                    image: null
                };
            }
        });

        // Cargar datos desde localStorage al iniciar
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('acuarelaCapas');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // Asegurar que la estructura de paleta existe
                    if (!parsed.palette) {
                        parsed.palette = {
                            description: "",
                            paletaAcuarela: null,
                            paletaRetratos: null,
                            paletaVariantes: null
                        };
                    }
                    
                    layerData = parsed;
                    
                    // Actualizar la interfaz con los datos cargados
                    layers.forEach(layer => {
                        if (layer.isPalette) {
                            const textarea = document.getElementById(`textarea-palette`);
                            if (textarea && layerData['palette']) {
                                textarea.value = layerData['palette'].description || '';
                                
                                ['paletaAcuarela', 'paletaRetratos', 'paletaVariantes'].forEach(paletteType => {
                                    const preview = document.getElementById(`preview-palette-${paletteType}`);
                                    const removeBtn = document.getElementById(`remove-palette-${paletteType}`);
                                    
                                    if (layerData['palette'][paletteType]) {
                                        preview.src = layerData['palette'][paletteType];
                                        preview.classList.add('show');
                                        removeBtn.classList.add('show');
                                    }
                                });
                            }
                        } else {
                            const textarea = document.getElementById(`textarea-${layer.id}`);
                            const preview = document.getElementById(`preview-${layer.id}`);
                            const removeBtn = document.getElementById(`remove-${layer.id}`);
                            
                            if (textarea && layerData[layer.id]) {
                                textarea.value = layerData[layer.id].description || '';
                                
                                if (layerData[layer.id].image) {
                                    preview.src = layerData[layer.id].image;
                                    preview.classList.add('show');
                                    removeBtn.classList.add('show');
                                }
                            }
                        }
                    });
                    showNotification('Datos cargados automáticamente');
                }
            } catch (error) {
                console.error('Error al cargar desde localStorage:', error);
            }
        }

        // Guardar en localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('acuarelaCapas', JSON.stringify(layerData));
            } catch (error) {
                console.error('Error al guardar en localStorage:', error);
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        function saveData(layerId) {
            const textarea = document.getElementById(`textarea-${layerId}`);
            layerData[layerId].description = textarea.value;
            try {
                saveToLocalStorage();
                showNotification(`Capa ${layerId} guardada`);
            } catch (error) {
                showNotification(`Error al guardar Capa ${layerId}: Espacio insuficiente`);
            }
        }

        function compressImage(base64, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Redimensionar si es necesario
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convertir a base64 con compresión
                    const compressed = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressed);
                };
                img.src = base64;
            });
        }

        function handleImageUpload(layerId, event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // Comprimir la imagen antes de guardar
                    const compressed = await compressImage(e.target.result);
                    layerData[layerId].image = compressed;
                    
                    const preview = document.getElementById(`preview-${layerId}`);
                    const removeBtn = document.getElementById(`remove-${layerId}`);
                    preview.src = compressed;
                    preview.classList.add('show');
                    removeBtn.classList.add('show');
                    
                    try {
                        saveToLocalStorage();
                        showNotification(`Imagen agregada a Capa ${layerId}`);
                    } catch (error) {
                        showNotification(`Error al guardar Capa ${layerId}: Imagen muy grande`);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function handlePaletteImageUpload(paletteType, event) {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const compressed = await compressImage(e.target.result);
                    layerData['palette'][paletteType] = compressed;
                    
                    const preview = document.getElementById(`preview-palette-${paletteType}`);
                    const removeBtn = document.getElementById(`remove-palette-${paletteType}`);
                    preview.src = compressed;
                    preview.classList.add('show');
                    removeBtn.classList.add('show');
                    
                    try {
                        saveToLocalStorage();
                        showNotification(`Paleta agregada`);
                    } catch (error) {
                        showNotification(`Error al guardar paleta: Imagen muy grande`);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removePaletteImage(paletteType) {
            layerData['palette'][paletteType] = null;
            const preview = document.getElementById(`preview-palette-${paletteType}`);
            const removeBtn = document.getElementById(`remove-palette-${paletteType}`);
            const input = document.getElementById(`upload-palette-${paletteType}`);
            preview.src = '';
            preview.classList.remove('show');
            removeBtn.classList.remove('show');
            input.value = '';
            saveToLocalStorage();
            showNotification(`Paleta eliminada`);
        }

        function removeImage(layerId) {
            layerData[layerId].image = null;
            const preview = document.getElementById(`preview-${layerId}`);
            const removeBtn = document.getElementById(`remove-${layerId}`);
            const input = document.getElementById(`upload-${layerId}`);
            preview.src = '';
            preview.classList.remove('show');
            removeBtn.classList.remove('show');
            input.value = '';
            saveToLocalStorage();
            showNotification(`Imagen eliminada de Capa ${layerId}`);
        }

        function exportJSON() {
            const dataStr = JSON.stringify(layerData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'acuarela-capas.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('JSON exportado');
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            
                            // Verificar si el formato es el antiguo (solo strings) o el nuevo (objetos)
                            const firstKey = Object.keys(imported)[0];
                            const isOldFormat = typeof imported[firstKey] === 'string';
                            
                            if (isOldFormat) {
                                // Convertir formato antiguo a nuevo
                                Object.keys(imported).forEach(key => {
                                    layerData[key] = {
                                        description: imported[key],
                                        image: null
                                    };
                                });
                            } else {
                                // Comprimir imágenes al importar
                                for (let key in imported) {
                                    if (key === 'palette') {
                                        // Manejar paleta de colores
                                        if (imported[key].paletaAcuarela) {
                                            imported[key].paletaAcuarela = await compressImage(imported[key].paletaAcuarela);
                                        }
                                        if (imported[key].paletaRetratos) {
                                            imported[key].paletaRetratos = await compressImage(imported[key].paletaRetratos);
                                        }
                                        if (imported[key].paletaVariantes) {
                                            imported[key].paletaVariantes = await compressImage(imported[key].paletaVariantes);
                                        }
                                    } else if (imported[key].image) {
                                        imported[key].image = await compressImage(imported[key].image);
                                    }
                                }
                                layerData = imported;
                            }
                            
                            // Guardar en localStorage
                            try {
                                saveToLocalStorage();
                            } catch (error) {
                                showNotification('Datos importados pero no se pudieron guardar en memoria');
                            }
                            
                            // Actualizar todos los textareas e imágenes
                            layers.forEach(layer => {
                                if (layer.isPalette) {
                                    // Actualizar paleta de colores
                                    const textarea = document.getElementById(`textarea-palette`);
                                    if (textarea && layerData['palette']) {
                                        textarea.value = layerData['palette'].description || '';
                                        
                                        // Actualizar las tres paletas
                                        ['paletaAcuarela', 'paletaRetratos', 'paletaVariantes'].forEach(paletteType => {
                                            const preview = document.getElementById(`preview-palette-${paletteType}`);
                                            const removeBtn = document.getElementById(`remove-palette-${paletteType}`);
                                            const uploadInput = document.getElementById(`upload-palette-${paletteType}`);
                                            
                                            if (layerData['palette'][paletteType]) {
                                                preview.src = layerData['palette'][paletteType];
                                                preview.classList.add('show');
                                                removeBtn.classList.add('show');
                                            } else {
                                                preview.src = '';
                                                preview.classList.remove('show');
                                                removeBtn.classList.remove('show');
                                                if (uploadInput) uploadInput.value = '';
                                            }
                                        });
                                    }
                                } else {
                                    // Actualizar capas normales
                                    const textarea = document.getElementById(`textarea-${layer.id}`);
                                    const preview = document.getElementById(`preview-${layer.id}`);
                                    const removeBtn = document.getElementById(`remove-${layer.id}`);
                                    const uploadInput = document.getElementById(`upload-${layer.id}`);
                                    
                                    if (textarea && layerData[layer.id]) {
                                        textarea.value = layerData[layer.id].description || '';
                                        
                                        if (layerData[layer.id].image) {
                                            preview.src = layerData[layer.id].image;
                                            preview.classList.add('show');
                                            removeBtn.classList.add('show');
                                        } else {
                                            preview.src = '';
                                            preview.classList.remove('show');
                                            removeBtn.classList.remove('show');
                                            if (uploadInput) uploadInput.value = '';
                                        }
                                    }
                                }
                            });
                            showNotification('JSON importado correctamente');
                        } catch (error) {
                            console.error('Error al importar:', error);
                            showNotification('Error al importar JSON: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Crear las tarjetas
        const container = document.getElementById('container');
        layers.forEach(layer => {
            const card = document.createElement('div');
            card.className = 'card';
            
            if (layer.isPalette) {
                // Tarjeta especial de paleta de colores
                card.innerHTML = `
                    <div class="card-header ${layer.class}">
                        ${layer.title}
                    </div>
                    <div class="card-body">
                        <div class="image-upload-container">
                            <label>Paleta de acuarela:</label>
                            <label class="upload-btn" for="upload-palette-paletaAcuarela">
                                📷 Subir paleta de acuarela
                            </label>
                            <input 
                                type="file" 
                                id="upload-palette-paletaAcuarela" 
                                accept="image/*"
                                style="display: none;"
                                onchange="handlePaletteImageUpload('paletaAcuarela', event)"
                            >
                            <img id="preview-palette-paletaAcuarela" class="image-preview" alt="Preview">
                            <button 
                                id="remove-palette-paletaAcuarela" 
                                class="remove-image" 
                                onclick="removePaletteImage('paletaAcuarela')"
                            >
                                Eliminar imagen
                            </button>
                        </div>
                        
                        <div class="image-upload-container">
                            <label>Paleta para retratos:</label>
                            <label class="upload-btn" for="upload-palette-paletaRetratos">
                                📷 Subir paleta para retratos
                            </label>
                            <input 
                                type="file" 
                                id="upload-palette-paletaRetratos" 
                                accept="image/*"
                                style="display: none;"
                                onchange="handlePaletteImageUpload('paletaRetratos', event)"
                            >
                            <img id="preview-palette-paletaRetratos" class="image-preview" alt="Preview">
                            <button 
                                id="remove-palette-paletaRetratos" 
                                class="remove-image" 
                                onclick="removePaletteImage('paletaRetratos')"
                            >
                                Eliminar imagen
                            </button>
                        </div>
                        
                        <div class="image-upload-container">
                            <label>Paleta para variantes:</label>
                            <label class="upload-btn" for="upload-palette-paletaVariantes">
                                📷 Subir paleta para variantes
                            </label>
                            <input 
                                type="file" 
                                id="upload-palette-paletaVariantes" 
                                accept="image/*"
                                style="display: none;"
                                onchange="handlePaletteImageUpload('paletaVariantes', event)"
                            >
                            <img id="preview-palette-paletaVariantes" class="image-preview" alt="Preview">
                            <button 
                                id="remove-palette-paletaVariantes" 
                                class="remove-image" 
                                onclick="removePaletteImage('paletaVariantes')"
                            >
                                Eliminar imagen
                            </button>
                        </div>
                        
                        <label for="textarea-palette">Descripciones:</label>
                        <textarea 
                            id="textarea-palette" 
                            placeholder="Escribe las descripciones de las paletas..."
                        ></textarea>
                        
                        <div class="button-group">
                            <button class="btn-save" onclick="saveData('palette')">Guardar</button>
                            <button class="btn-export" onclick="exportJSON()">ExJson</button>
                            <button class="btn-import" onclick="importJSON()">ImJson</button>
                        </div>
                    </div>
                `;
            } else {
                // Tarjetas normales de capas
                card.innerHTML = `
                    <div class="card-header ${layer.class}">
                        ${layer.title}
                    </div>
                    <div class="card-body">
                        <label for="textarea-${layer.id}">Descripción:</label>
                        <textarea 
                            id="textarea-${layer.id}" 
                            placeholder="Escribe los detalles de esta capa..."
                        ></textarea>
                        
                        <div class="image-upload-container">
                            <label class="upload-btn" for="upload-${layer.id}">
                                📷 Subir imagen de referencia
                            </label>
                            <input 
                                type="file" 
                                id="upload-${layer.id}" 
                                accept="image/*"
                                style="display: none;"
                                onchange="handleImageUpload(${layer.id}, event)"
                            >
                            <img id="preview-${layer.id}" class="image-preview" alt="Preview">
                            <button 
                                id="remove-${layer.id}" 
                                class="remove-image" 
                                onclick="removeImage(${layer.id})"
                            >
                                Eliminar imagen
                            </button>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-save" onclick="saveData(${layer.id})">Guardar</button>
                            <button class="btn-export" onclick="exportJSON()">ExJson</button>
                            <button class="btn-import" onclick="importJSON()">ImJson</button>
                        </div>
                    </div>
                `;
            }
            container.appendChild(card);
        });

        // Cargar datos al iniciar la aplicación
        loadFromLocalStorage();
    </script>
</body>
</html>