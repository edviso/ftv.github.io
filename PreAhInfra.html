<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Predicci√≥n de Amperios (PV) ‚Äî v1.4</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#2563eb;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --cool:#1e3a8a;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--text)}
  header{padding:16px 14px 8px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  h1{font-size:18px; margin:0}
  .subtitle{color:var(--muted); font-size:13px; flex:1 1 100%}
  .header-actions{margin-left:auto}
  .wrap{padding:10px 14px 24px}
  .card{background:var(--card); border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,.04); padding:14px; margin:12px 0; overflow:hidden}
  /* layout: la segunda columna puede encogerse sin salirse */
  .row{display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; margin:10px 0}
  .row > :last-child{min-width:0}
  .label{font-size:14px}
  .hint{font-size:12px; color:var(--muted)}
  .step{display:grid; grid-template-columns:38px 96px 38px; align-items:center; gap:6px}
  .step button{height:38px; border:none; border-radius:12px; background:#eef2ff; font-size:18px; cursor:pointer}
  .step input{height:38px; text-align:center; border:1px solid #e5e7eb; border-radius:12px; font-size:15px; padding:0 6px}
  /* inputs ocupan el ancho disponible */
  input[type="time"], input[type="date"], input[type="number"], input[type="text"]{
    border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; font-size:15px; background:#fff;
    width:100%; max-width:100%;
  }
  /* columnas internas que se encogen sin desbordar */
  .grid2{display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:10px}
  .grid3{display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap:8px}
  .btn{display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:12px 16px; border:none; border-radius:14px; background:var(--accent); color:#fff; font-weight:600; font-size:16px; cursor:pointer}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#eef2ff; color:#111827}
  .btn.sm{padding:8px 12px; font-size:13px; border-radius:10px}
  .btn:active{transform:scale(0.98)}
  .out{display:grid; gap:10px}
  .kpi{display:grid; grid-template-columns:1fr auto; align-items:end; padding:12px; border-radius:14px; background:#f3f4f6}
  .kpi .value{font-size:28px; font-weight:800}
  .kpi .range{font-size:13px; color:var(--muted)}
  .badge{padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; color:#fff}
  .badge.red{background:var(--bad)}
  .badge.orange{background:var(--warn)}
  .badge.green{background:var(--ok)}
  .badge.blue{background:var(--cool)}
  details textarea{width:100%; min-height:140px; padding:10px; border-radius:12px; border:1px solid #e5e7eb}
  /* el texto t√©cnico/clim√°tico hace wrap dentro de la tarjeta */
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap; overflow-wrap:anywhere}
  .page-bottom{display:flex; justify-content:flex-end; padding:10px 0}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.7)}100%{box-shadow:0 0 0 12px rgba(37,99,235,0)}}
  .flash{animation:flash .5s ease}
</style>
</head>
<body>
  <header>
    <h1>Predicci√≥n de Amperios (PV)</h1>
    <div class="subtitle">Modelo con p√©rdidas, ventana de sol directo y clima Open-Meteo ¬∑ <b>v1.4</b></div>
    <div class="header-actions">
      <button class="btn ghost sm" id="btnCopyHtml" type="button">üìã Copiar HTML</button>
      <button class="btn ghost sm" id="btnDownload" type="button">‚¨áÔ∏è Descargar</button>
    </div>
  </header>
  <div class="wrap">

    <div class="card">
      <div class="row">
        <div class="label"><b>Fecha</b></div>
        <div class="grid3">
          <input id="fecha" type="date" />
          <button class="btn ghost sm" id="btnHoy" type="button">Hoy</button>
          <button class="btn ghost sm" id="btnMas1" type="button">+1 d√≠a</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Latitud / Longitud</div>
        <div class="grid2">
          <input id="lat" type="number" inputmode="decimal" step="0.0001" />
          <input id="lon" type="number" inputmode="decimal" step="0.0001" />
        </div>
      </div>
      <div class="row">
        <div class="label">Voltaje medio del banco (V)</div>
        <div class="step" data-id="vbank" data-step="0.1" data-min="10" data-max="16">
          <button class="btn-step" data-delta="-0.1" type="button">‚àí</button>
          <input id="vbank" type="number" inputmode="decimal" step="0.1" />
          <button class="btn-step" data-delta="0.1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Eficiencia base del arreglo (%)</div>
        <div class="step" data-id="effBase" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="effBase" type="number" inputmode="numeric" />
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Cielo visible (0‚Äì1)</div>
        <div class="step" data-id="cieloVis" data-step="0.01" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.01" type="button">‚àí</button>
          <input id="cieloVis" type="number" inputmode="decimal" step="0.01" />
          <button class="btn-step" data-delta="0.01" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Factor difuso <b>fuera</b> de ventana (0‚Äì1)</div>
        <div class="step" data-id="kDif" data-step="0.05" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.05" type="button">‚àí</button>
          <input id="kDif" type="number" inputmode="decimal" step="0.01" />
          <button class="btn-step" data-delta="0.05" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Factor difuso <b>dentro</b> de ventana (0‚Äì1)</div>
        <div class="step" data-id="kDifIn" data-step="0.05" data-min="0" data-max="1">
          <button class="btn-step" data-delta="-0.05" type="button">‚àí</button>
          <input id="kDifIn" type="number" inputmode="decimal" step="0.01" />
          <button class="btn-step" data-delta="0.05" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Sol directo</div>
        <div class="grid2">
          <input id="hIni" type="time" />
          <input id="hFin" type="time" />
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:2px 0 8px">P√©rdidas del sistema</h3>
      <div class="row">
        <div class="label">El√©ctrica (%)</div>
        <div class="step" data-id="pElec" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pElec" type="number" inputmode="numeric" />
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">Suciedad (%)</div>
        <div class="step" data-id="pDirt" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pDirt" type="number" inputmode="numeric" />
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">MPPT (%)</div>
        <div class="step" data-id="pMppt" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pMppt" type="number" inputmode="numeric" />
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">√Ångulo (%)</div>
        <div class="step" data-id="pAng" data-step="1" data-min="50" data-max="100">
          <button class="btn-step" data-delta="-1" type="button">‚àí</button>
          <input id="pAng" type="number" inputmode="numeric" />
          <button class="btn-step" data-delta="1" type="button">+</button>
        </div>
      </div>
      <div class="hint">Todos los porcentajes se aplican como multiplicadores (p/100).</div>
    </div>

    <div class="card">
      <div class="grid2">
        <button class="btn" id="btnCalc" type="button">üîÑ Recalcular con Open-Meteo</button>
        <button class="btn secondary" id="btnGuardar" type="button">üíæ Guardar como predeterminado</button>
      </div>
      <details style="margin-top:10px">
        <summary class="hint">Alternativa: pegar JSON manual (estructura Open-Meteo o la tuya en espa√±ol)</summary>
        <textarea id="jsonManual" placeholder="Pega aqu√≠ el JSON y pulsa ‚ÄòCalcular con JSON‚Äô"></textarea>
        <div class="grid2" style="margin-top:8px">
          <button class="btn ghost sm" id="btnCalcJson" type="button">Calcular con JSON</button>
          <button class="btn ghost sm" id="btnLimpiarJson" type="button">Limpiar</button>
        </div>
      </details>
    </div>

    <div class="card out" id="panelOut" hidden>
      <div class="kpi">
        <div>
          <div class="hint">Amperios previstos (12√ó60 W, 6 bater√≠as)</div>
          <div class="value" id="ahValue">‚Äî</div>
          <div class="range" id="ahRange">‚Äî</div>
        </div>
        <div><span class="badge" id="badgeUso">‚Äî</span></div>
      </div>
      <div class="grid2">
        <div class="card" style="padding:10px">
          <div class="hint">Resumen t√©cnico</div>
          <pre class="mono" id="resume" style="margin:0"></pre>
        </div>
        <div class="card" style="padding:10px">
          <div class="hint">Sol y variabilidad</div>
          <pre class="mono" id="sunInfo" style="margin:0"></pre>
        </div>
      </div>
      <div class="page-bottom">
        <button class="btn ghost sm" id="btnCalc3" type="button">Recalcular</button>
      </div>
    </div>

  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const fmt = n => n.toLocaleString('es-EC', {maximumFractionDigits:0});
  const f2 = n => n.toLocaleString('es-EC', {maximumFractionDigits:2});

  // Predeterminados (los de tu imagen)
  const defaults = {
    fecha: todayStr(0),
    lat: -2.125,
    lon: -79.875,
    vbank: 13.0,
    effBase: 75,
    cieloVis: 0.65,
    kDif: 0.25,
    kDifIn: 0.35,
    hIni: '09:00',
    hFin: '14:00',
    pElec: 90,
    pDirt: 94,
    pMppt: 85,
    pAng: 93
  };

  function todayStr(shiftDays){ const d=new Date(); d.setDate(d.getDate()+(shiftDays||0)); return d.toISOString().slice(0,10); }

  // --- Cargar desde localStorage (robusto)
  function safeMerge(def, saved){
    const out = {...def};
    for(const k in (saved||{})){
      const v = saved[k];
      if (['fecha','hIni','hFin'].includes(k)) { if (typeof v==='string' && v) out[k]=v; }
      else if (typeof v==='number' && Number.isFinite(v)) out[k]=v;
    }
    return out;
  }
  let saved = {};
  try{
    const raw = localStorage.getItem('pvPredictDefaults');
    if (raw) saved = JSON.parse(raw);
  }catch(e){
    // si estaba corrupto, lo limpiamos para no romper el script
    localStorage.removeItem('pvPredictDefaults');
    saved = {};
  }
  const state = safeMerge(defaults, saved);

  // Poner valores en el DOM
  const setVal = (id,val)=>{ const el=document.getElementById(id); if(el!=null) el.value=val; };
  setVal('fecha', state.fecha);
  setVal('lat', state.lat); setVal('lon', state.lon);
  setVal('vbank', state.vbank);
  setVal('effBase', state.effBase);
  setVal('cieloVis', state.cieloVis);
  setVal('kDif', state.kDif); setVal('kDifIn', state.kDifIn);
  setVal('hIni', state.hIni); setVal('hFin', state.hFin);
  setVal('pElec', state.pElec); setVal('pDirt', state.pDirt); setVal('pMppt', state.pMppt); setVal('pAng', state.pAng);

  // Fecha r√°pida
  $('#btnHoy').onclick = ()=> setVal('fecha', todayStr(0));
  $('#btnMas1').onclick = ()=> setVal('fecha', todayStr(1));

  // Delegaci√≥n +/‚àí
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-step'); if(!btn) return;
    const stepEl = btn.parentElement; const input = stepEl.querySelector('input');
    const min = parseFloat(stepEl.dataset.min); const max = parseFloat(stepEl.dataset.max);
    const step = parseFloat(stepEl.dataset.step); const delta = parseFloat(btn.dataset.delta);
    let v = parseFloat(input.value||0)+delta; v=Math.min(max,Math.max(min,v)); v=Math.round(v/step)*step;
    input.value = (step%1!==0) ? v.toFixed(2) : String(v);
  });

  // Edici√≥n manual con l√≠mites
  document.querySelectorAll('.step input').forEach(el=>{
    el.addEventListener('input', ()=>{
      const stepEl = el.parentElement; let v = parseFloat(el.value);
      if(isNaN(v)) return; const min=parseFloat(stepEl.dataset.min); const max=parseFloat(stepEl.dataset.max); const step=parseFloat(stepEl.dataset.step);
      v=Math.min(max,Math.max(min,v)); v=Math.round(v/step)*step; el.value=(step%1!==0)?v.toFixed(2):String(v);
    });
  });

  // Acciones
  $('#btnCalc').onclick = run; $('#btnCalc3').onclick = run;
  $('#btnGuardar').onclick = ()=>{ localStorage.setItem('pvPredictDefaults', JSON.stringify(readInputs())); toast('Valores guardados como predeterminados.'); };

  // Copiar HTML
  const btnCopy = document.getElementById('btnCopyHtml');
  if(btnCopy){ btnCopy.onclick = async ()=>{ try{ const html='<!DOCTYPE html>\n'+document.documentElement.outerHTML; await navigator.clipboard.writeText(html); flash(btnCopy,'¬°Copiado!'); }catch(e){ toast('No se pudo copiar: '+e.message); } }; }
  const btnDownload = document.getElementById('btnDownload');
  if(btnDownload){ btnDownload.onclick = ()=>{ const blob=new Blob(['<!DOCTYPE html>\n'+document.documentElement.outerHTML], {type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pv_prediccion_ah_v1_4.html'; a.click(); URL.revokeObjectURL(a.href); }; }

  // JSON manual
  $('#btnCalcJson').onclick = ()=>{ const txt=$('#jsonManual').value.trim(); if(!txt){ toast('Pega un JSON v√°lido.'); return; } try{ const obj=JSON.parse(txt); const parsed=parseAnyJson(obj); if(!parsed){ toast('No pude interpretar ese JSON.'); return; } computeWithSeries(parsed); }catch(e){ toast('JSON inv√°lido: '+e.message); } };
  $('#btnLimpiarJson').onclick = ()=> $('#jsonManual').value='';

  function readInputs(){
    return {
      fecha: $('#fecha').value,
      lat: parseFloat($('#lat').value), lon: parseFloat($('#lon').value),
      vbank: parseFloat($('#vbank').value), effBase: parseFloat($('#effBase').value),
      cieloVis: parseFloat($('#cieloVis').value), kDif: parseFloat($('#kDif').value), kDifIn: parseFloat($('#kDifIn').value),
      hIni: $('#hIni').value, hFin: $('#hFin').value,
      pElec: parseFloat($('#pElec').value), pDirt: parseFloat($('#pDirt').value), pMppt: parseFloat($('#pMppt').value), pAng: parseFloat($('#pAng').value)
    };
  }

  async function run(){
    const p = readInputs(); if(p.hIni>=p.hFin){ toast('La hora de inicio debe ser menor que la de fin.'); return; }
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Guayaquil';
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude', p.lat); url.searchParams.set('longitude', p.lon); url.searchParams.set('timezone', tz);
    url.searchParams.set('start_date', p.fecha); url.searchParams.set('end_date', p.fecha);
    url.searchParams.set('hourly','cloud_cover,temperature_2m,relative_humidity_2m,precipitation_probability,wind_speed_10m');
    url.searchParams.set('daily','sunrise,sunset');
    try{ const res=await fetch(url.toString()); if(!res.ok) throw new Error('HTTP '+res.status); const data=await res.json(); const parsed=parseOpenMeteo(data); computeWithSeries(parsed,p); }
    catch(e){ toast('Fallo Open-Meteo: '+e.message); }
  }

  function parseOpenMeteo(data){ const times=data?.hourly?.time||[]; const cloud=data?.hourly?.cloud_cover||[]; const sunrise=data?.daily?.sunrise?.[0]||null; const sunset=data?.daily?.sunset?.[0]||null; return {times,cloud,sunrise,sunset}; }

  function parseAnyJson(obj){ if(obj?.hourly?.time && (obj?.hourly?.cloud_cover||obj?.hourly?.nubes)){ const cloud=obj.hourly.cloud_cover||obj.hourly.nubes; const sunrise=obj?.daily?.sunrise?.[0]||null; const sunset=obj?.daily?.sunset?.[0]||null; return {times:obj.hourly.time, cloud, sunrise, sunset}; } const ch=obj['cada hora']||obj['cada_hora']||obj['cadaHora']; if(ch&&(ch['nubes']||ch['nubosidad'])&&ch['tiempo']){ const sunrise=obj?.diario?.amanecer||obj?.daily?.sunrise?.[0]||null; const sunset=obj?.diario?.atardecer||obj?.daily?.sunset?.[0]||null; return {times:ch['tiempo'], cloud:ch['nubes']||ch['nubosidad'], sunrise, sunset}; } return null; }

  function computeWithSeries(series, params){
    const p=params||readInputs(); const {times,cloud}=series; if(!times?.length||!cloud?.length){ toast('Serie horaria incompleta.'); return; }
    const sunrise=series.sunrise?new Date(series.sunrise):new Date(p.fecha+'T06:00'); const sunset=series.sunset?new Date(series.sunset):new Date(p.fecha+'T18:00');
    const hIni=toHM(p.hIni); const hFin=toHM(p.hFin);
    const P_nom=12*60; const P_eff=P_nom*(p.effBase/100)*(p.pElec/100)*(p.pDirt/100)*(p.pMppt/100)*(p.pAng/100);
    let HSE=0; const cloudsDay=[];
    for(let i=0;i<times.length;i++){
      const t=new Date(times[i]); if(!(t>=sunrise&&t<sunset)) continue; const h=t.getHours(); const inside=(h>=hIni.h && h<hFin.h);
      const cc=clamp(cloud[i],0,100); const c=cc/100; const clear=1-c; const base=inside?1.0:(p.kDif||0.25);
      const fEff=((clear)+(c*(p.kDifIn||0.35)))*(p.cieloVis||0.65)*base; HSE+=fEff; cloudsDay.push(cc);
    }
    if(HSE===0){ for(let i=0;i<times.length;i++){ const cc=clamp(cloud[i],0,100); const c=cc/100; const clear=1-c; const fEff=((clear)+(c*(p.kDifIn||0.35)))*(p.cieloVis||0.65)*(p.kDif||0.25); HSE+=fEff; cloudsDay.push(cc);} }
    const Wh=P_eff*HSE; const Ah=Wh/p.vbank; const sigma=stddev(cloudsDay); const bandPct=0.10+0.2*(sigma/100); const AhLow=Ah*(1-bandPct); const AhHigh=Ah*(1+bandPct);
    document.getElementById('panelOut').hidden=false;
    document.getElementById('ahValue').textContent=`${fmt(Ah)} Ah`;
    document.getElementById('ahRange').textContent=`Rango: ${fmt(AhLow)} ‚Äì ${fmt(AhHigh)} Ah (¬± ${(bandPct*100).toFixed(1)}%)`;
    const uso=usoRecomendado(Ah); const badge=document.getElementById('badgeUso'); badge.textContent=uso.text; badge.className='badge '+uso.cl;
    document.getElementById('resume').textContent=`P_nom = 12√ó60 W = ${P_nom} W\nP_eff = ${f2(P_eff)} W\nHSE = ${f2(HSE)} h\nEnerg√≠a = ${fmt(Wh)} Wh\nVoltaje banco = ${p.vbank.toFixed(1)} V\nAmperios = ${fmt(Ah)} Ah`;
    const sr=fmtHM(sunrise), ss=fmtHM(sunset);
    document.getElementById('sunInfo').textContent=`Amanecer: ${sr}  ¬∑  Atardecer: ${ss}\nVentana directo: ${p.hIni}‚Äì${p.hFin}\nCielo visible: ${p.cieloVis}  ¬∑  Difuso ext: ${p.kDif}  ¬∑  Difuso int: ${p.kDifIn}\nœÉ(nubosidad d√≠a) = ${sigma.toFixed(1)} pts`;
  }

  function usoRecomendado(Ah){ if(Ah<=47) return {text:'Ahorro', cl:'red'}; if(Ah<=53) return {text:'Normal', cl:'green'}; return {text:'Holgado', cl:'blue'}; }
  function clamp(x,min,max){ return Math.min(max, Math.max(min,x)); }
  function toHM(str){ const [h,m]=str.split(':').map(x=>parseInt(x,10)); return {h,m}; }
  function stddev(arr){ if(!arr.length) return 0; const m=arr.reduce((a,b)=>a+b,0)/arr.length; const v=arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length; return Math.sqrt(v); }
  function fmtHM(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
  function toast(msg){ const n=document.createElement('div'); n.textContent=msg; n.style.position='fixed'; n.style.left='50%'; n.style.bottom='90px'; n.style.transform='translateX(-50%)'; n.style.background='#111827'; n.style.color='#fff'; n.style.padding='10px 14px'; n.style.borderRadius='12px'; n.style.fontSize='14px'; n.style.boxShadow='0 8px 20px rgba(0,0,0,.2)'; document.body.appendChild(n); setTimeout(()=>n.remove(),1600); }
  function flash(btn, okText){ const old=btn.textContent; btn.textContent='‚úî '+okText; btn.classList.add('flash'); setTimeout(()=>{btn.textContent=old; btn.classList.remove('flash');}, 1100); }
})();
</script>
</body>
</html>