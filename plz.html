<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Plan de Ahorro con P√≥lizas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        input, select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .results-section {
            display: none;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 1.8em;
            font-weight: 700;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .table-container {
            margin: 30px 0;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child {
            text-align: center;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: right;
        }

        td:first-child {
            text-align: center;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .highlight-row {
            background: #fff3cd !important;
            font-weight: 600;
        }

        h2 {
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .observation {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Calculadora de Plan de Ahorro con P√≥lizas</h1>

        <div class="error-message" id="errorMessage"></div>

        <div class="form-section">
            <form id="simulationForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="monthlyContribution">Aporte Mensual (USD)</label>
                        <input type="number" id="monthlyContribution" value="300" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="years">N√∫mero de A√±os a Simular</label>
                        <select id="years" required>
                            <option value="1">1 a√±o</option>
                            <option value="2">2 a√±os</option>
                            <option value="3">3 a√±os</option>
                            <option value="4">4 a√±os</option>
                            <option value="5" selected>5 a√±os</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="monthlyRate">Tasa Anual P√≥liza Mensual (%)</label>
                        <input type="number" id="monthlyRate" value="3.45" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="daysInMonth">D√≠as del Mes (P√≥liza Mensual)</label>
                        <input type="number" id="daysInMonth" value="31" min="1" max="31" required>
                    </div>

                    <div class="form-group">
                        <label for="annualRate">Tasa Anual P√≥liza Anual (%)</label>
                        <input type="number" id="annualRate" value="4.95" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="simulationMode">Modo de Simulaci√≥n</label>
                        <select id="simulationMode" required>
                            <option value="monthly">Solo P√≥lizas Mensuales</option>
                            <option value="annual">Solo P√≥lizas Anuales</option>
                            <option value="combined" selected>Modo Combinado (Mensuales + Anuales)</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">üöÄ Simular</button>
                    <button type="button" class="btn-secondary" id="clearBtn">üîÑ Limpiar</button>
                </div>
            </form>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>üìà Resumen General</h2>
            <div class="summary-cards" id="summaryCards"></div>

            <div class="chart-container">
                <h3>Evoluci√≥n del Saldo Total</h3>
                <canvas id="chartCanvas" width="800" height="400"></canvas>
            </div>

            <h2>üìã Detalle Mensual</h2>
            <div class="table-container">
                <table id="monthlyTable">
                    <thead>
                        <tr>
                            <th>A√±o</th>
                            <th>Mes</th>
                            <th>Mes Global</th>
                            <th>Aporte</th>
                            <th>Saldo Antes Int.</th>
                            <th>Inter√©s Mensual</th>
                            <th>Saldo Final Mes</th>
                            <th>Capital P√≥liza Anual</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody"></tbody>
                </table>
            </div>

            <h2>üìä Resumen por A√±o</h2>
            <div class="table-container">
                <table id="yearlyTable">
                    <thead>
                        <tr>
                            <th>A√±o</th>
                            <th>Aporte Total</th>
                            <th>Inter√©s Mensuales</th>
                            <th>Inter√©s Anual</th>
                            <th>Capital Reinvertido</th>
                            <th>Saldo Total Fin A√±o</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const form = document.getElementById('simulationForm');
        const clearBtn = document.getElementById('clearBtn');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');

        // Funci√≥n para formatear n√∫meros como moneda
        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Funci√≥n para mostrar errores
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para calcular inter√©s mensual prorrateado por d√≠as
        function calculateMonthlyInterest(balance, annualRate, days) {
            // Inter√©s = saldo √ó (tasa_anual / 100) √ó (d√≠as / 365)
            return balance * (annualRate / 100) * (days / 365);
        }

        // Funci√≥n para calcular inter√©s anual simple
        function calculateAnnualInterest(capital, annualRate) {
            // Inter√©s = capital √ó (tasa_anual / 100)
            return capital * (annualRate / 100);
        }

        // Funci√≥n principal de simulaci√≥n
        function runSimulation(params) {
            const {
                monthlyContribution,
                totalMonths,
                monthlyRate,
                daysInMonth,
                annualRate,
                mode
            } = params;

            // Arrays para almacenar los datos
            const monthlyData = [];
            const yearlyData = [];

            // Variables de control
            let totalContributed = 0;
            let totalMonthlyInterest = 0;
            let totalAnnualInterest = 0;
            let annualPolicyCapital = 0; // Capital que est√° en p√≥liza anual
            let monthlyBalance = 0; // Saldo de los aportes mensuales del a√±o actual

            // Simulaci√≥n mes por mes
            for (let month = 1; month <= totalMonths; month++) {
                const year = Math.ceil(month / 12);
                const monthInYear = ((month - 1) % 12) + 1;
                let observation = '';

                // Datos del mes actual
                const monthData = {
                    year: year,
                    monthInYear: monthInYear,
                    globalMonth: month,
                    contribution: monthlyContribution,
                    balanceBeforeInterest: 0,
                    monthlyInterest: 0,
                    balanceAfterInterest: 0,
                    annualPolicyCapital: annualPolicyCapital,
                    observation: ''
                };

                // MODO: SOLO P√ìLIZAS MENSUALES
                if (mode === 'monthly') {
                    // Agregar el aporte mensual
                    monthlyBalance += monthlyContribution;
                    totalContributed += monthlyContribution;

                    monthData.balanceBeforeInterest = monthlyBalance;

                    // Calcular inter√©s mensual
                    const interest = calculateMonthlyInterest(monthlyBalance, monthlyRate, daysInMonth);
                    monthlyBalance += interest;
                    totalMonthlyInterest += interest;

                    monthData.monthlyInterest = interest;
                    monthData.balanceAfterInterest = monthlyBalance;
                    monthData.annualPolicyCapital = 0;

                    if (monthInYear === 12) {
                        observation = 'Fin de a√±o';
                    }
                }
                // MODO: SOLO P√ìLIZAS ANUALES
                else if (mode === 'annual') {
                    // Los aportes mensuales se acumulan sin inter√©s durante el a√±o
                    monthlyBalance += monthlyContribution;
                    totalContributed += monthlyContribution;

                    monthData.balanceBeforeInterest = monthlyBalance;
                    monthData.monthlyInterest = 0;
                    monthData.balanceAfterInterest = monthlyBalance;
                    monthData.annualPolicyCapital = annualPolicyCapital;

                    // Al final del a√±o, aplicar inter√©s anual sobre el capital acumulado
                    if (monthInYear === 12) {
                        const annualInterest = calculateAnnualInterest(monthlyBalance, annualRate);
                        totalAnnualInterest += annualInterest;

                        // El capital para el pr√≥ximo a√±o es el actual + inter√©s
                        annualPolicyCapital = monthlyBalance + annualInterest;
                        monthlyBalance = 0; // Resetear para el siguiente a√±o

                        observation = `Fin de a√±o: Inter√©s anual = ${formatCurrency(annualInterest)}`;
                    }
                }
                // MODO: COMBINADO (Mensuales + Anuales)
                else if (mode === 'combined') {
                    // Agregar el aporte mensual al saldo mensual del a√±o actual
                    monthlyBalance += monthlyContribution;
                    totalContributed += monthlyContribution;

                    monthData.balanceBeforeInterest = monthlyBalance;

                    // Calcular inter√©s mensual sobre el saldo mensual
                    const monthlyInterest = calculateMonthlyInterest(monthlyBalance, monthlyRate, daysInMonth);
                    monthlyBalance += monthlyInterest;
                    totalMonthlyInterest += monthlyInterest;

                    monthData.monthlyInterest = monthlyInterest;
                    monthData.balanceAfterInterest = monthlyBalance;
                    monthData.annualPolicyCapital = annualPolicyCapital;

                    // Al final del a√±o
                    if (monthInYear === 12) {
                        let annualInterest = 0;

                        // Si hay capital en p√≥liza anual, calcular su inter√©s
                        if (annualPolicyCapital > 0) {
                            annualInterest = calculateAnnualInterest(annualPolicyCapital, annualRate);
                            totalAnnualInterest += annualInterest;
                        }

                        // Para el siguiente a√±o:
                        // El capital de la p√≥liza anual ser√°:
                        // - Capital anterior + inter√©s anual + bloque mensual del a√±o
                        const newAnnualCapital = annualPolicyCapital + annualInterest + monthlyBalance;

                        observation = `Fin de a√±o: Bloque mensual = ${formatCurrency(monthlyBalance)}`;
                        if (annualPolicyCapital > 0) {
                            observation += `, Inter√©s anual = ${formatCurrency(annualInterest)}`;
                        }
                        observation += `, Capital reinvertido = ${formatCurrency(newAnnualCapital)}`;

                        // Actualizar para el siguiente a√±o
                        annualPolicyCapital = newAnnualCapital;
                        monthlyBalance = 0; // Resetear saldo mensual
                    }
                }

                monthData.observation = observation;
                monthlyData.push(monthData);

                // Agregar datos anuales al final de cada a√±o
                if (monthInYear === 12) {
                    const yearContributions = monthlyContribution * 12;
                    const yearMonthlyInterests = monthlyData
                        .filter(m => m.year === year)
                        .reduce((sum, m) => sum + m.monthlyInterest, 0);

                    let yearAnnualInterest = 0;
                    let reinvestedCapital = 0;
                    let totalEndOfYear = 0;

                    if (mode === 'monthly') {
                        totalEndOfYear = monthlyBalance;
                        reinvestedCapital = 0;
                    } else if (mode === 'annual') {
                        yearAnnualInterest = totalAnnualInterest - yearlyData.reduce((sum, y) => sum + y.annualInterest, 0);
                        totalEndOfYear = annualPolicyCapital;
                        reinvestedCapital = annualPolicyCapital;
                    } else if (mode === 'combined') {
                        yearAnnualInterest = totalAnnualInterest - yearlyData.reduce((sum, y) => sum + y.annualInterest, 0);
                        totalEndOfYear = annualPolicyCapital;
                        reinvestedCapital = annualPolicyCapital;
                    }

                    yearlyData.push({
                        year: year,
                        totalContributions: yearContributions,
                        monthlyInterests: yearMonthlyInterests,
                        annualInterest: yearAnnualInterest,
                        reinvestedCapital: reinvestedCapital,
                        totalEndOfYear: totalEndOfYear
                    });
                }
            }

            // Calcular saldo final total
            let finalBalance = 0;
            if (mode === 'monthly') {
                finalBalance = monthlyBalance;
            } else if (mode === 'annual' || mode === 'combined') {
                finalBalance = annualPolicyCapital;
            }

            // Retornar todos los resultados
            return {
                monthlyData: monthlyData,
                yearlyData: yearlyData,
                summary: {
                    totalMonths: totalMonths,
                    totalContributed: totalContributed,
                    totalMonthlyInterest: totalMonthlyInterest,
                    totalAnnualInterest: totalAnnualInterest,
                    finalBalance: finalBalance,
                    totalReturn: ((finalBalance - totalContributed) / totalContributed * 100)
                }
            };
        }

        // Funci√≥n para mostrar los resultados
        function displayResults(results) {
            const { monthlyData, yearlyData, summary } = results;

            // Mostrar resumen en tarjetas
            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="card">
                    <div class="card-title">Total de Meses</div>
                    <div class="card-value">${summary.totalMonths}</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Aportado</div>
                    <div class="card-value">${formatCurrency(summary.totalContributed)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Inter√©s P√≥lizas Mensuales</div>
                    <div class="card-value">${formatCurrency(summary.totalMonthlyInterest)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Inter√©s P√≥lizas Anuales</div>
                    <div class="card-value">${formatCurrency(summary.totalAnnualInterest)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Saldo Final</div>
                    <div class="card-value">${formatCurrency(summary.finalBalance)}</div>
                </div>
                <div class="card">
                    <div class="card-title">Rendimiento Total</div>
                    <div class="card-value">${summary.totalReturn.toFixed(2)}%</div>
                </div>
            `;

            // Mostrar tabla mensual
            const monthlyTableBody = document.getElementById('monthlyTableBody');
            monthlyTableBody.innerHTML = '';
            monthlyData.forEach(row => {
                const tr = document.createElement('tr');
                if (row.monthInYear === 12) {
                    tr.classList.add('highlight-row');
                }
                tr.innerHTML = `
                    <td>${row.year}</td>
                    <td>${row.monthInYear}</td>
                    <td>${row.globalMonth}</td>
                    <td>${formatCurrency(row.contribution)}</td>
                    <td>${formatCurrency(row.balanceBeforeInterest)}</td>
                    <td>${formatCurrency(row.monthlyInterest)}</td>
                    <td>${formatCurrency(row.balanceAfterInterest)}</td>
                    <td>${formatCurrency(row.annualPolicyCapital)}</td>
                    <td class="observation">${row.observation}</td>
                `;
                monthlyTableBody.appendChild(tr);
            });

            // Mostrar tabla anual
            const yearlyTableBody = document.getElementById('yearlyTableBody');
            yearlyTableBody.innerHTML = '';
            yearlyData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.year}</td>
                    <td>${formatCurrency(row.totalContributions)}</td>
                    <td>${formatCurrency(row.monthlyInterests)}</td>
                    <td>${formatCurrency(row.annualInterest)}</td>
                    <td>${formatCurrency(row.reinvestedCapital)}</td>
                    <td>${formatCurrency(row.totalEndOfYear)}</td>
                `;
                yearlyTableBody.appendChild(tr);
            });

            // Dibujar gr√°fico
            drawChart(yearlyData);

            // Mostrar la secci√≥n de resultados
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Funci√≥n para dibujar el gr√°fico con Canvas
        function drawChart(yearlyData) {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Limpiar canvas
            ctx.clearRect(0, 0, width, height);

            if (yearlyData.length === 0) return;

            // Configuraci√≥n del gr√°fico
            const padding = 60;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;

            // Encontrar valores m√°ximos
            const maxValue = Math.max(...yearlyData.map(y => y.totalEndOfYear));
            const years = yearlyData.map(y => y.year);

            // Dibujar ejes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Dibujar l√≠nea de datos
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();

            yearlyData.forEach((data, index) => {
                const x = padding + (index / (yearlyData.length - 1)) * chartWidth;
                const y = height - padding - (data.totalEndOfYear / maxValue) * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Dibujar puntos
                ctx.fillStyle = '#764ba2';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();

                // Dibujar etiquetas
                ctx.fillStyle = '#333';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`A√±o ${data.year}`, x, height - padding + 20);
                ctx.fillText(formatCurrency(data.totalEndOfYear), x, y - 10);
            });

            ctx.stroke();

            // T√≠tulo del eje Y
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Saldo Total (USD)', 0, 0);
            ctx.restore();
        }

        // Evento de env√≠o del formulario
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Obtener valores del formulario
            const monthlyContribution = parseFloat(document.getElementById('monthlyContribution').value);
            const years = parseInt(document.getElementById('years').value);
            const monthlyRate = parseFloat(document.getElementById('monthlyRate').value);
            const daysInMonth = parseInt(document.getElementById('daysInMonth').value);
            const annualRate = parseFloat(document.getElementById('annualRate').value);
            const mode = document.getElementById('simulationMode').value;

            // Validar inputs
            if (isNaN(monthlyContribution) || monthlyContribution < 0) {
                showError('Por favor, ingrese un aporte mensual v√°lido.');
                return;
            }

            if (isNaN(monthlyRate) || monthlyRate < 0) {
                showError('Por favor, ingrese una tasa anual v√°lida para p√≥liza mensual.');
                return;
            }

            if (isNaN(annualRate) || annualRate < 0) {
                showError('Por favor, ingrese una tasa anual v√°lida para p√≥liza anual.');
                return;
            }

            if (isNaN(daysInMonth) || daysInMonth < 1 || daysInMonth > 31) {
                showError('Por favor, ingrese un n√∫mero de d√≠as v√°lido (1-31).');
                return;
            }

            // Preparar par√°metros
            const params = {
                monthlyContribution: monthlyContribution,
                totalMonths: years * 12,
                monthlyRate: monthlyRate,
                daysInMonth: daysInMonth,
                annualRate: annualRate,
                mode: mode
            };

            // Ejecutar simulaci√≥n
            const results = runSimulation(params);

            // Mostrar resultados
            displayResults(results);
        });

        // Evento del bot√≥n limpiar
        clearBtn.addEventListener('click', function() {
            form.reset();
            resultsSection.style.display = 'none';
            errorMessage.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>