<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="theme-color" content="#1f2937" />
  <title>Munich Amber Ale lote 54 v1</title>
  <style>
    :root {
      /* Paleta gris/azulada + acentos suaves */
      --bg-top: #eef2f5;
      --bg-bottom: #dbe4ea;
      --ink: #111827;           /* Gris muy oscuro para texto principal */
      --ink-2: #374151;         /* Gris oscuro secundario */
      --muted: #6b7280;         /* Gris medio */
      --card: #ffffffee;        /* Blancogris transl√∫cido */
      --shadow: 0 6px 20px rgba(17, 24, 39, 0.08);
      --radius: 16px;
      --radius-sm: 12px;
      --speed: 220ms;
      --border: #e5e7eb;

      /* Colores de etapas (pedidos por el usuario) */
      --arranque: #fff9c4;     /* üü° Arranque limpio */
      --vigorosa: #ffcdd2;     /* üî¥ Fermentaci√≥n vigorosa */
      --final: #ffe0b2;        /* üü† Final primaria + diacetilo */
      --maduracion: #d7ccc8;   /* üü§ Maduraci√≥n c√°lida */
      --cold-1: #bbdefb;       /* üîµ Cold crash (claro) */
      --cold-2: #0d47a1;       /* üîµ Cold crash (oscuro) */
      --embotellado: #e1bee7;  /* üü£ Embotellado + priming */
      --carb: #c8e6c9;         /* üü¢ Carbonataci√≥n en botella */
      --mad-botella: #bdbdbd;  /* ‚ö´ Maduraci√≥n en botella */
      --accent: #94a3b8;       /* azul gris√°ceo para detalles sutiles */
      --accent-strong: #64748b;

      --min-font: 14px;        /* Tipograf√≠a m√≠nima en m√≥vil */
    }

    html, body { height: 100%; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
      -webkit-tap-highlight-color: transparent;
      font-size: var(--min-font);
    }

    .wrap { max-width: 720px; margin: 0 auto; padding: 10px 12px 28px; }

    /* ===== Encabezado compacto (‚â§ 25% altura) ===== */
    header.app-hd {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.35));
      backdrop-filter: saturate(120%) blur(4px);
      border-bottom: 1px solid var(--border);
    }
    .hd-inner { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 10px 4px; align-items: center; }
    .title {
      line-height: 1.15; margin: 0; font-size: clamp(18px, 4.2vw, 20px); font-weight: 700; color: var(--ink);
    }
    .subtitle { margin: 2px 0 0; font-size: clamp(13px, 3.8vw, 14px); color: var(--muted); font-weight: 500; }
    .meta-row { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
    .pill { font-variant-numeric: tabular-nums; padding: 3px 8px; border-radius: 999px; background: #f3f4f6; color: var(--ink-2); border: 1px solid var(--border); }
    .btn-ghost { appearance: none; border: 1px solid var(--border); background: #f9fafb; color: var(--ink-2); padding: 7px 10px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: var(--shadow); }

    /* ===== Tarjetas (colapsables y fija) ===== */
    .cards { display: grid; gap: 10px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-hd {
      display: grid; grid-template-columns: 1fr auto; align-items: center;
      padding: 12px 14px; cursor: pointer; user-select: none;
    }
    .card-hd .h {
      display: flex; align-items: baseline; gap: 8px;
    }
    .card-hd .h .t { font-weight: 700; font-size: 14px; color: var(--ink); }
    .card-hd .h .s { font-size: 12px; color: var(--muted); }

    .chev { width: 10px; height: 10px; border-right: 2px solid var(--ink-2); border-bottom: 2px solid var(--ink-2); transform: rotate(-45deg); transition: transform var(--speed) ease; margin-left: 8px; }
    .card.open .chev { transform: rotate(135deg); }

    .card-body { block-size: auto; max-height: 0; overflow: hidden; transition: max-height var(--speed) ease, opacity var(--speed) ease; opacity: 0; padding: 0 14px; }
    .card.open .card-body { max-height: 900px; opacity: 1; padding: 0 14px 12px; }

    /* Grids internos compactos */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .field { display: grid; gap: 4px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input, .field textarea, .field select {
      width: 100%; padding: 9px 10px; border-radius: 10px; border: 1px solid var(--border); background: #f9fafb; color: var(--ink-2);
      font-size: 14px; outline: none;
    }
    .field textarea { min-height: 76px; resize: vertical; }

    /* ===== Control Diario (SIEMPRE visible) ===== */
    .day-card .card-hd { cursor: default; }
    .legend { display: grid; grid-auto-flow: column; grid-auto-columns: max-content; gap: 10px; padding: 0 14px 10px; overflow-x: auto; }
    .chip { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); white-space: nowrap; }
    .sw { width: 14px; height: 10px; border-radius: 3px; display:inline-block; border: 1px solid rgba(0,0,0,0.08); }

    .days-wrap { padding: 2px 6px 12px; }
    .days {
      display: flex; gap: 8px; overflow-x: auto; padding: 6px; scroll-snap-type: x mandatory; scroll-padding: 12px;
      -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; border-top: 1px dashed var(--border);
    }

    .day {
      flex: 0 0 auto; scroll-snap-align: start; min-width: 184px; max-width: 220px;
      border: 2px solid transparent; border-radius: var(--radius-sm); padding: 8px 10px; line-height: 1.25; text-align: left; background: #f3f4f6;
      box-shadow: 0 6px 16px rgba(2,6,23,0.04);
      transition: transform var(--speed) ease, box-shadow var(--speed) ease, border-color var(--speed) ease;
      white-space: normal; word-break: keep-all;
    }
    .day strong { display:block; font-size: 13px; margin-bottom: 2px; color: #111827; }
    .day .stage { display:block; font-size: 12px; color: #0f172a; font-weight: 600; }
    .day .temp { display:block; font-size: 12px; color: #111827; }
    .day:active { transform: scale(0.98); box-shadow: 0 4px 12px rgba(2,6,23,0.06); }

    .day[data-today="true"] { border-color: var(--accent-strong); box-shadow: 0 0 0 2px rgba(100,116,139,0.15) inset, 0 8px 18px rgba(2,6,23,0.1); }

    /* Etapas -> fondos */
    .stage-arranque { background: var(--arranque); }
    .stage-vigorosa { background: var(--vigorosa); }
    .stage-final { background: var(--final); }
    .stage-maduracion { background: var(--maduracion); }
    .stage-cold { background: linear-gradient(180deg, var(--cold-1), var(--cold-2)); color: #f5faff; }
    .stage-embotellado { background: var(--embotellado); }
    .stage-carb { background: var(--carb); }
    .stage-madbotella { background: linear-gradient(180deg, #eeeeee, var(--mad-botella)); }

    /* ===== Dialog de edici√≥n r√°pida ===== */
    dialog#editDialog {
      border: none; border-radius: 18px; box-shadow: 0 20px 50px rgba(2,6,23,0.25);
      padding: 12px; width: min(92vw, 420px);
    }
    dialog::backdrop { background: rgba(15, 23, 42, 0.45); backdrop-filter: blur(2px); }
    .dhd { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 2px 6px 10px; }
    .dhd h3 { margin: 0; font-size: 15px; }
    .dft { display:grid; gap:10px; }
    .dlg-row { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .dlg-actions { display:flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
    .btn { appearance:none; border:1px solid var(--border); padding:9px 12px; border-radius: 10px; font-weight:700; font-size: 13px; }
    .btn.primary { background: var(--accent-strong); color: #fff; border-color: transparent; }

    /* Accesibilidad t√°ctil */
    .touch-target { min-height: 38px; display:flex; align-items:center; }

    /* Peque√±os remates */
    .muter { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ===== Encabezado ===== -->
    <header class="app-hd" aria-label="Encabezado">
      <div class="hd-inner">
        <div>
          <h1 class="title">Munich Amber Ale lote 54 v1</h1>
          <p class="subtitle">American Amber Ale / Munich Amber Ale (BJCP 19A)</p>
          <div class="meta-row">
            <span class="pill" id="startPill">Inicio: <b>‚Äî</b></span>
            <span class="pill" id="todayPill">Hoy: <b>‚Äî</b></span>
          </div>
        </div>
        <div>
          <button id="btnSettings" class="btn-ghost touch-target" aria-label="Ajustes">Ajustes</button>
        </div>
      </div>
    </header>

    <!-- ===== Control Diario (siempre visible) ===== -->
    <section class="card day-card" aria-label="Control diario de temperatura">
      <div class="card-hd" style="cursor:default">
        <div class="h">
          <span class="t">Control Diario de Temperatura (60 d√≠as)</span>
          <span class="s pill" id="hoyPill">‚Äî</span>
        </div>
        <span class="chev" style="opacity:.35"></span>
      </div>
      <div class="legend" aria-label="Leyenda de etapas">
        <div class="chip"><span class="sw" style="background:var(--arranque)"></span>Arranque limpio</div>
        <div class="chip"><span class="sw" style="background:var(--vigorosa)"></span>Fermentaci√≥n vigorosa</div>
        <div class="chip"><span class="sw" style="background:var(--final)"></span>Final primaria + diacetilo</div>
        <div class="chip"><span class="sw" style="background:var(--maduracion)"></span>Maduraci√≥n c√°lida</div>
        <div class="chip"><span class="sw" style="background:linear-gradient(180deg,var(--cold-1),var(--cold-2))"></span>Cold crash</div>
        <div class="chip"><span class="sw" style="background:var(--embotellado)"></span>Embotellado + priming</div>
        <div class="chip"><span class="sw" style="background:var(--carb)"></span>Carbonataci√≥n en botella</div>
        <div class="chip"><span class="sw" style="background:linear-gradient(180deg,#eee,var(--mad-botella))"></span>Maduraci√≥n en botella</div>
      </div>
      <div class="days-wrap">
        <div id="days" class="days" role="listbox" aria-label="D√≠as del proceso (desliza horizontalmente)"></div>
      </div>
    </section>

    <!-- ===== Tarjetas colapsables (inician cerradas) ===== -->
    <div class="cards" id="cards">
      <!-- Datos generales -->
      <section class="card collapsible" data-key="datos">
        <div class="card-hd" role="button" tabindex="0" aria-expanded="false">
          <div class="h"><span class="t">Datos Generales</span><span class="s muter">volumen, ABV, OG, FG, IBUs, color</span></div>
          <i class="chev"></i>
        </div>
        <div class="card-body">
          <div class="grid-3">
            <div class="field"><label>Volumen (L)</label><input id="volumen" inputmode="decimal" /></div>
            <div class="field"><label>ABV (%)</label><input id="abv" inputmode="decimal" /></div>
            <div class="field"><label>Color (EBC)</label><input id="ebc" inputmode="decimal" /></div>
          </div>
          <div class="grid-3" style="margin-top:8px;">
            <div class="field"><label>OG</label><input id="og" /></div>
            <div class="field"><label>FG</label><input id="fg" /></div>
            <div class="field"><label>IBUs</label><input id="ibus" inputmode="numeric" /></div>
          </div>
        </div>
      </section>

      <!-- Ingredientes -->
      <section class="card collapsible" data-key="ingredientes">
        <div class="card-hd" role="button" tabindex="0" aria-expanded="false">
          <div class="h"><span class="t">Ingredientes</span><span class="s muter">granos (%) y EBC</span></div>
          <i class="chev"></i>
        </div>
        <div class="card-body">
          <div class="grid-2">
            <div class="field"><label>Pilsen (%)</label><input id="gr-pilsen" inputmode="decimal" /></div>
            <div class="field"><label>Pilsen (EBC)</label><input id="gr-pilsen-ebc" inputmode="decimal" /></div>
            <div class="field"><label>Munich (%)</label><input id="gr-munich" inputmode="decimal" /></div>
            <div class="field"><label>Munich (EBC)</label><input id="gr-munich-ebc" inputmode="decimal" /></div>
            <div class="field"><label>Pale Ale (%)</label><input id="gr-pale" inputmode="decimal" /></div>
            <div class="field"><label>Pale Ale (EBC)</label><input id="gr-pale-ebc" inputmode="decimal" /></div>
            <div class="field"><label>Cara 20 MD (%)</label><input id="gr-cara" inputmode="decimal" /></div>
            <div class="field"><label>Cara 20 MD (EBC)</label><input id="gr-cara-ebc" inputmode="decimal" /></div>
            <div class="field"><label>Malta chocolate (%)</label><input id="gr-choco" inputmode="decimal" /></div>
            <div class="field"><label>Malta chocolate (EBC)</label><input id="gr-choco-ebc" inputmode="decimal" /></div>
            <div class="field"><label>Levadura</label><input id="levadura" /></div>
            <div class="field"><label>Observaciones</label><textarea id="ing-notas" placeholder="Notas r√°pidas‚Ä¶"></textarea></div>
          </div>
        </div>
      </section>

      <!-- L√∫pulos -->
      <section class="card collapsible" data-key="lupulos">
        <div class="card-hd" role="button" tabindex="0" aria-expanded="false">
          <div class="h"><span class="t">L√∫pulos</span><span class="s muter">variedades, tiempos e IBUs</span></div>
          <i class="chev"></i>
        </div>
        <div class="card-body">
          <div class="grid-3">
            <div class="field"><label>Variedad #1</label><input id="hop1" placeholder="Simcoe‚Ä¶" /></div>
            <div class="field"><label>Tiempo (min)</label><input id="hop1t" inputmode="numeric" /></div>
            <div class="field"><label>IBUs</label><input id="hop1i" inputmode="decimal" /></div>
            <div class="field"><label>Variedad #2</label><input id="hop2" placeholder="Cascade‚Ä¶" /></div>
            <div class="field"><label>Tiempo (min)</label><input id="hop2t" inputmode="numeric" /></div>
            <div class="field"><label>IBUs</label><input id="hop2i" inputmode="decimal" /></div>
            <div class="field"><label>Variedad #3</label><input id="hop3" /></div>
            <div class="field"><label>Tiempo (min)</label><input id="hop3t" inputmode="numeric" /></div>
            <div class="field"><label>IBUs</label><input id="hop3i" inputmode="decimal" /></div>
          </div>
        </div>
      </section>

      <!-- Macerado -->
      <section class="card collapsible" data-key="mash">
        <div class="card-hd" role="button" tabindex="0" aria-expanded="false">
          <div class="h"><span class="t">Macerado</span><span class="s muter">pasos, temperaturas y agua</span></div>
          <i class="chev"></i>
        </div>
        <div class="card-body">
          <div class="grid-3">
            <div class="field"><label>Paso 1 (¬∞C)</label><input id="m1t" inputmode="decimal" /></div>
            <div class="field"><label>Agua 1 (L)</label><input id="m1w" inputmode="decimal" /></div>
            <div class="field"><label>Tiempo 1 (min)</label><input id="m1d" inputmode="numeric" /></div>
            <div class="field"><label>Paso 2 (¬∞C)</label><input id="m2t" inputmode="decimal" /></div>
            <div class="field"><label>Agua 2 (L)</label><input id="m2w" inputmode="decimal" /></div>
            <div class="field"><label>Tiempo 2 (min)</label><input id="m2d" inputmode="numeric" /></div>
            <div class="field"><label>Mash out (¬∞C)</label><input id="m3t" inputmode="decimal" /></div>
            <div class="field"><label>Lavado (L)</label><input id="m3w" inputmode="decimal" /></div>
            <div class="field"><label>Tiempo total (min)</label><input id="mtd" inputmode="numeric" /></div>
          </div>
        </div>
      </section>

      <!-- Notas de estilo -->
      <section class="card collapsible" data-key="styleNotes">
        <div class="card-hd" role="button" tabindex="0" aria-expanded="false">
          <div class="h"><span class="t">Notas de estilo</span><span class="s muter">BJCP y objetivos sensoriales</span></div>
          <i class="chev"></i>
        </div>
        <div class="card-body">
          <div class="field"><label>Notas</label><textarea id="style-notes" placeholder="Aroma a caramelo moderado, amargor medio, perfil limpio‚Ä¶"></textarea></div>
        </div>
      </section>
    </div>
  </div>

  <!-- ===== Editor de d√≠a ===== -->
  <dialog id="editDialog">
    <form method="dialog" id="editForm">
      <div class="dhd">
        <h3 id="editTitle">Editar d√≠a</h3>
        <button class="btn" value="cancel" formnovalidate>Cancelar</button>
      </div>
      <div class="dft">
        <div class="field">
          <label>Etapa</label>
          <select id="stageSel">
            <option value="arranque">Arranque limpio</option>
            <option value="vigorosa">Fermentaci√≥n vigorosa</option>
            <option value="final">Final primaria + descanso diacetilo</option>
            <option value="maduracion">Maduraci√≥n c√°lida</option>
            <option value="cold">Cold crash</option>
            <option value="embotellado">Embotellado + priming</option>
            <option value="carb">Carbonataci√≥n en botella</option>
            <option value="madbotella">Maduraci√≥n en botella</option>
          </select>
        </div>
        <div class="dlg-row">
          <div class="field"><label>T¬∞ alta (¬∞C)</label><input id="tHi" inputmode="decimal" /></div>
          <div class="field"><label>T¬∞ baja (¬∞C)</label><input id="tLo" inputmode="decimal" /></div>
        </div>
        <div class="muter">Sugerencia: toca el d√≠a en la lista para editarlo. Los cambios se guardan localmente.</div>
        <div class="dlg-actions">
          <button class="btn" value="cancel" formnovalidate>Cerrar</button>
          <button class="btn primary" id="saveDay" value="default">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- ===== Ajustes r√°pidos ===== -->
  <dialog id="settingsDialog">
    <form method="dialog" id="settingsForm">
      <div class="dhd">
        <h3>Ajustes del lote</h3>
        <button class="btn" value="cancel" formnovalidate>Cerrar</button>
      </div>
      <div class="dft">
        <div class="field">
          <label>Fecha de inicio</label>
          <input type="date" id="startDateInp" />
        </div>
        <div class="muter">Este archivo funciona sin internet. Puedes exportar o borrar los datos locales cuando desees.</div>
        <div class="dlg-actions">
          <button class="btn" id="btnReset" type="button">Borrar datos</button>
          <button class="btn primary" id="btnSaveSettings" value="default">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    /* ==========================================================
       App Lote 54 v1 ‚Äî HTML √∫nico, sin dependencias externas
       - Optimizado para m√≥vil (Android)
       - Todo persiste en localStorage (clave: lote54v1_r1)
       - Barra diaria deslizable: 60 d√≠as, editable por toque
       ========================================================== */

    const STORAGE_KEY = 'lote54v1_r1';

    const STAGES = {
      arranque: { label: 'Arranque limpio', cls: 'stage-arranque', def: { hi: 19, lo: 18 } },
      vigorosa: { label: 'Fermentaci√≥n vigorosa', cls: 'stage-vigorosa', def: { hi: 20, lo: 19 } },
      final: { label: 'Final primaria + descanso diacetilo', cls: 'stage-final', def: { hi: 19, lo: 18 } },
      maduracion: { label: 'Maduraci√≥n c√°lida', cls: 'stage-maduracion', def: { hi: 20, lo: 18 } },
      cold: { label: 'Cold crash', cls: 'stage-cold', def: { hi: 4, lo: 3 } },
      embotellado: { label: 'Embotellado + priming', cls: 'stage-embotellado', def: { hi: 20, lo: 20 } },
      carb: { label: 'Carbonataci√≥n en botella', cls: 'stage-carb', def: { hi: 20, lo: 20 } },
      madbotella: { label: 'Maduraci√≥n en botella', cls: 'stage-madbotella', def: { hi: 18, lo: 16 } },
    };

    // Programa por defecto (60 d√≠as). Incluye el detalle que nos pediste: Cold crash inicia en el d√≠a 13.
    const DEFAULT_SCHEDULE = [
      // 1-2 Arranque limpio
      ...Array(2).fill('arranque'),
      // 3-5 Vigorosa
      ...Array(3).fill('vigorosa'),
      // 6-10 Final primaria + diacetilo
      ...Array(5).fill('final'),
      // 11-12 Maduraci√≥n c√°lida
      ...Array(2).fill('maduracion'),
      // 13-14 Cold crash
      ...Array(2).fill('cold'),
      // 15 Embotellado + priming
      'embotellado',
      // 16-26 Carbonataci√≥n en botella (11 d√≠as)
      ...Array(11).fill('carb'),
      // 27-60 Maduraci√≥n en botella (34 d√≠as)
      ...Array(34).fill('madbotella'),
    ];

    // Garantiza longitud 60
    while (DEFAULT_SCHEDULE.length < 60) DEFAULT_SCHEDULE.push('madbotella');
    if (DEFAULT_SCHEDULE.length > 60) DEFAULT_SCHEDULE.length = 60;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const state = loadState();

    init();

    /* ===== Inicializaci√≥n general ===== */
    function init() {
      // Header pills
      updateHeaderPills();

      // Construir cards colapsables
      $$('.collapsible').forEach(card => {
        const hd = card.querySelector('.card-hd');
        hd.addEventListener('click', () => toggleCard(card));
        hd.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCard(card); }});
      });

      // Construir d√≠as
      buildDays();

      // Scroll al d√≠a de hoy
      scrollToToday();

      // Inputs -> persistencia
      bindFormPersistence();

      // Ajustes
      $('#btnSettings').addEventListener('click', openSettings);
      $('#btnSaveSettings').addEventListener('click', saveSettings);
      $('#btnReset').addEventListener('click', resetAll);

      // Dialog day editor
      $('#saveDay').addEventListener('click', saveDayEdit);
    }

    function toggleCard(card) {
      const open = card.classList.toggle('open');
      card.querySelector('.card-hd').setAttribute('aria-expanded', String(open));
    }

    /* ===== Estado y persistencia ===== */
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      let st = null;
      if (raw) {
        try { st = JSON.parse(raw); } catch {}
      }
      if (!st) {
        // Estado por defecto
        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const days = Array.from({ length: 60 }, (_, i) => {
          const key = DEFAULT_SCHEDULE[i] || 'madbotella';
          const def = STAGES[key].def;
          return { stage: key, hi: def.hi, lo: def.lo };
        });
        st = {
          startDate: startDate.toISOString().slice(0,10),
          days,
          fields: {}
        };
      }
      // Defaults reales ‚Äì se aplican solo si falta el valor o est√° vac√≠o
      const defaults = {
        volumen: "14",
        abv: "6.07",
        ebc: "30.3",
        og: "1.061",
        fg: "1.015",
        ibus: "19.7",
        "gr-pilsen": "38.4",
        "gr-pilsen-ebc": "3.9",
        "gr-munich": "38.4",
        "gr-munich-ebc": "17.7",
        "gr-pale": "15.3",
        "gr-pale-ebc": "5.9",
        "gr-cara": "6.4",
        "gr-cara-ebc": "39.4",
        "gr-choco": "1.5",
        "gr-choco-ebc": "886.5",
        "ing-notas": "Pesos de grano (g):\n- Pilsen: 1500 g\n- Munich: 1500 g\n- Pale: 600 g\n- Caramelo/Crystal: 250 g\n- Chocolate: 60 g\nTotal: 3910 g.",
        hop1: "Simcoe",
        hop1t: "50",
        hop1i: "19.7",
        hop2: "Cascade",
        hop2t: "0",
        hop2i: "0",
        m1t: "66.7",
        m1w: "12.70",
        m1d: "60",
        m2t: "67.8",
        m2w: "8.79",
        m2d: "20",
        m3t: "",
        m3w: "",
        mtd: "80",
        "style-notes": "Perfil: maltoso, con notas de caramelo y leve tostado.\nColor: √°mbar profundo (30.3 EBC).\nAmargor: moderado bajo (19.7 IBUs, por debajo del rango cl√°sico 25‚Äì40, lo que lo hace m√°s dulce).\nAroma: el Cascade a 0 min da toques c√≠tricos/florales frescos.\nAlcohol: 6.07 %, en el l√≠mite superior del estilo."
      };
      st.fields = st.fields || {};
      for (const [k, v] of Object.entries(defaults)) {
        if (st.fields[k] == null || st.fields[k] === '') st.fields[k] = v;
      }
      return st;
    }

    function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    /* ===== D√≠as ===== */
    function buildDays() {
      const box = $('#days');
      box.innerHTML = '';
      const start = new Date(state.startDate + 'T00:00:00');
      const today = new Date();
      const idxToday = clamp( Math.floor((stripTime(today) - stripTime(start)) / 86400000), -999, 999 );

      for (let i=0; i<60; i++) {
        const info = state.days[i];
        const date = addDays(start, i);
        const isToday = i === idxToday;
        const el = document.createElement('button');
        el.type = 'button';
        el.className = `day ${classForStage(info.stage)}`;
        el.setAttribute('role','option');
        el.dataset.index = i;
        el.dataset.today = isToday ? 'true' : 'false';

        el.innerHTML = `
          <strong>${formatDateES(date)} (D√≠a ${i+1})</strong>
          <span class="stage">${STAGES[info.stage].label}</span>
          <span class="temp">${fmtTemp(info.hi)} ‚Äì ${fmtTemp(info.lo)}</span>
        `;

        el.addEventListener('click', () => openDayEditor(i));
        box.appendChild(el);
      }

      // Legend pill: hoy
      const t = today;
      $('#hoyPill').textContent = `Hoy: ${formatDateES(t)}`;
    }

    function classForStage(key) { return STAGES[key]?.cls || STAGES.madbotella.cls; }

    function openDayEditor(index) {
      const d = state.days[index];
      $('#editTitle').textContent = `Editar ‚Äî D√≠a ${index+1}`;
      $('#stageSel').value = d.stage;
      $('#tHi').value = d.hi;
      $('#tLo').value = d.lo;
      $('#editDialog').dataset.index = index;
      showDialog('#editDialog');
    }

    function saveDayEdit(ev) {
      const idx = Number($('#editDialog').dataset.index || -1);
      if (idx < 0) return;
      const stage = $('#stageSel').value;
      const hi = num($('#tHi').value, STAGES[stage].def.hi);
      const lo = num($('#tLo').value, STAGES[stage].def.lo);
      state.days[idx] = { stage, hi, lo };
      saveState();
      buildDays();
    }

    function scrollToToday() {
      const el = $('.day[data-today="true"]');
      if (el) el.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    /* ===== Encabezado ===== */
    function updateHeaderPills() {
      const start = new Date(state.startDate + 'T00:00:00');
      $('#startPill').innerHTML = `Inicio: <b>${formatDateES(start)}</b>`;
      $('#todayPill').innerHTML = `Hoy: <b>${formatDateES(new Date())}</b>`;
    }

    /* ===== Ajustes ===== */
    function openSettings() {
      $('#startDateInp').value = state.startDate;
      showDialog('#settingsDialog');
    }

    function saveSettings() {
      const v = $('#startDateInp').value;
      if (v) state.startDate = v;
      saveState();
      updateHeaderPills();
      buildDays();
    }

    function resetAll() {
      if (!confirm('Esto borrar√° los datos locales del lote. ¬øContinuar?')) return;
      localStorage.removeItem(STORAGE_KEY);
      const fresh = loadState();
      Object.assign(state, fresh);
      saveState();
      updateHeaderPills();
      buildDays();
    }

    /* ===== Persistencia de formularios de las tarjetas ===== */
    function bindFormPersistence() {
      const ids = [
        'volumen','abv','ebc','og','fg','ibus',
        'gr-pilsen','gr-pilsen-ebc','gr-munich','gr-munich-ebc','gr-pale','gr-pale-ebc','gr-cara','gr-cara-ebc','gr-choco','gr-choco-ebc','levadura','ing-notas',
        'hop1','hop1t','hop1i','hop2','hop2t','hop2i','hop3','hop3t','hop3i',
        'm1t','m1w','m1d','m2t','m2w','m2d','m3t','m3w','mtd',
        'style-notes'
      ];

      // cargar
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const val = state.fields?.[id];
        if (val !== undefined) el.value = val;
        el.addEventListener('input', debounce(() => {
          state.fields[id] = el.value;
          saveState();
        }, 200));
      });
    }

    /* ===== Utilidades ===== */
    function num(v, d=0) { const n = parseFloat(String(v).replace(',', '.')); return isFinite(n) ? n : d; }
    function addDays(d, n) { const r = new Date(d); r.setDate(r.getDate()+n); return r; }
    function stripTime(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function fmtTemp(v) { return `${num(v).toString().replace('.', ',')}¬∞C`; }

    function formatDateES(d) {
      const dd = d.getDate().toString().padStart(2,'0');
      const m = d.getMonth();
      const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
      return `${dd}/${meses[m]}`;
    }

    function showDialog(sel) {
      const dlg = $(sel);
      if (!dlg) return;
      if (typeof dlg.showModal === 'function') dlg.showModal();
      else alert('Tu navegador no soporta di√°logos.');
    }

    function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); }; }
  </script>
</body>
</html>
