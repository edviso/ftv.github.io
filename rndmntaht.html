<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rendimiento FV ¬∑ v1c</title>
<style>
  :root{--bg:#f7f7f7;--card:#fff;--ink:#111;--muted:#666;--line:#e6e6e6}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:880px;margin:24px auto;padding:16px}
  h1{font-size:22px;margin:0 0 12px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .title{font-size:18px;margin:0 0 10px 0}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input[type=number],select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fafafa;color:var(--ink)}
  .btn{display:inline-block;border-radius:14px;padding:12px 18px;border:1px solid var(--ink);background:var(--ink);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--ink)}
  #btnCalc{background:#000;color:#fff;border-color:#000}
  .kpi{background:#f3f3f3;border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
  .kpi .v{font-size:22px;font-weight:700}
  .kpi .l{font-size:12px;color:var(--muted)}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media (max-width:720px){.grid-3{grid-template-columns:1fr}}
  .seg{display:flex;gap:8px}
  .seg button{flex:1;border:1px solid var(--line);background:#fafafa;border-radius:12px;padding:12px;font-weight:600;cursor:pointer}
  .seg button.active{border-color:#111}
  .muted{color:var(--muted);font-size:12px}

  .spin{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .spin .controls{display:flex;gap:8px}
  .spin .step{width:46px;height:42px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-weight:700;font-size:18px;line-height:1;cursor:pointer}
  @media (max-width:720px){.spin{grid-template-columns:1fr 120px}}

  .good{color:#0b8a3b}
  .bad{color:#b03030}

  /* Tramos */
  .tr-row{border:1px solid var(--line);border-radius:14px;padding:10px;margin:10px 0;background:#fafafa}
  .tr-hdr{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .tr-grid{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;margin-top:8px}
  @media (max-width:720px){.tr-grid{grid-template-columns:1fr 1fr}}
  .mini{font-size:12px;color:var(--muted);margin-top:6px}
  .icon{font-style:normal;opacity:.75;margin-right:6px}
  .xbtn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Rendimiento fotovoltaico (micro-app) <span class="muted">v1c</span></h1>

  <div class="card">
    <div class="title">Modo</div>
    <div class="seg" id="modeSeg">
      <button data-mode="rapido" class="active">R√°pido</button>
      <button data-mode="detallado">Detallado</button>
    </div>
    <div class="muted" style="margin-top:8px">En ambos modos debes indicar: N¬∫ paneles, N¬∫ bater√≠as, eficiencia de paneles, eficiencia del sistema, voltaje de carga y temperatura.</div>
  </div>

  <div class="row">
    <div class="card">
      <div class="title">Par√°metros del sistema</div>

      <label>N¬∫ de paneles (60 W c/u)</label>
      <div class="spin">
        <input id="nPanels" type="number" min="1" step="1" value="2" />
        <div class="controls">
          <button class="step" data-t="#nPanels" data-d="-1">‚àí</button>
          <button class="step" data-t="#nPanels" data-d="1">+</button>
        </div>
      </div>

      <label>N¬∫ de bater√≠as (12.8 V ¬∑ 18 Ah c/u)</label>
      <div class="spin">
        <input id="nBats" type="number" min="1" step="1" value="2" />
        <div class="controls">
          <button class="step" data-t="#nBats" data-d="-1">‚àí</button>
          <button class="step" data-t="#nBats" data-d="1">+</button>
        </div>
      </div>

      <label>Eficiencia de paneles (%)</label>
      <div class="spin">
        <input id="effPanel" type="number" min="50" max="100" step="1" value="95" />
        <div class="controls">
          <button class="step" data-t="#effPanel" data-d="-1">‚àí</button>
          <button class="step" data-t="#effPanel" data-d="1">+</button>
        </div>
      </div>

      <label>Eficiencia del sistema (%)</label>
      <div class="spin">
        <input id="effSys" type="number" min="50" max="100" step="1" value="90" />
        <div class="controls">
          <button class="step" data-t="#effSys" data-d="-1">‚àí</button>
          <button class="step" data-t="#effSys" data-d="1">+</button>
        </div>
      </div>

      <label>Voltaje de carga V<sub>chg</sub> (V)</label>
      <div class="spin">
        <input id="vChg" type="number" step="0.01" value="13.80" />
        <div class="controls">
          <button class="step" data-t="#vChg" data-d="-0.01">‚àí</button>
          <button class="step" data-t="#vChg" data-d="0.01">+</button>
        </div>
      </div>

      <label>Temperatura ambiente (¬∞C)</label>
      <div class="spin">
        <input id="tAmb" type="number" step="0.5" value="30" />
        <div class="controls">
          <button class="step" data-t="#tAmb" data-d="-0.5">‚àí</button>
          <button class="step" data-t="#tAmb" data-d="0.5">+</button>
        </div>
      </div>

      <label>Controlador (A m√°x)</label>
      <div class="spin">
        <input id="ctrlA" type="number" min="1" step="1" value="30" />
        <div class="controls">
          <button class="step" data-t="#ctrlA" data-d="-1">‚àí</button>
          <button class="step" data-t="#ctrlA" data-d="1">+</button>
        </div>
      </div>
    </div>

    <div class="card" id="cardRapido">
      <div class="title">Clima ‚Äî Modo r√°pido</div>
      <label>Estado del cielo</label>
      <select id="skyQuick">
        <option value="soleado">Soleado</option>
        <option value="parcial">Parcialmente nublado</option>
        <option value="nublado">Nublado</option>
      </select>
      <div class="muted">HSP t√≠picos Guayaquil: 5.5 / 4.0 / 2.5 h-sol pico.</div>
    </div>

    <div class="card" id="cardDetallado" style="display:none">
      <div class="title">Clima ‚Äî Modo detallado</div>
      <label>Cielo</label>
      <select id="sky">
        <option value="despejado">Despejado</option>
        <option value="parcial">Parcial nublado</option>
        <option value="mayormente">Mayormente nublado</option>
        <option value="nublado">Nublado grueso</option>
        <option value="lluvia">Lluvia</option>
      </select>
      <label>Humedad</label>
      <select id="hum">
        <option value="baja">Baja</option>
        <option value="media">Media</option>
        <option value="alta">Alta</option>
        <option value="muyalta">Muy alta</option>
      </select>
      <label>Viento</label>
      <select id="wind">
        <option value="calma">Calma</option>
        <option value="leve">Leve</option>
        <option value="moderado">Moderado</option>
      </select>
      <label>HSP despejado de referencia (h)</label>
      <div class="spin">
        <input id="hspRef" type="number" step="0.1" value="5.0" />
        <div class="controls">
          <button class="step" data-t="#hspRef" data-d="-0.1">‚àí</button>
          <button class="step" data-t="#hspRef" data-d="0.1">+</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="seg" style="margin-bottom:10px">
      <button id="btnCalc" class="btn">Calcular</button>
      <button id="btnReset" class="btn secondary">Restablecer</button>
    </div>
    <div class="grid-3">
      <div class="kpi"><div class="l">Ah del d√≠a</div><div id="kAh" class="v">‚Äì</div></div>
      <div class="kpi"><div class="l">Corriente pico (A)</div><div id="kIp" class="v">‚Äì</div></div>
      <div class="kpi"><div class="l">Capacidad banco (Ah)</div><div id="kCap" class="v">‚Äì</div></div>
    </div>
    <div class="kpi" style="margin-top:10px"><div class="l">Cobertura PV sobre banco</div><div id="kCov" class="v">‚Äì</div></div>
    <details style="margin-top:10px">
      <summary>Desglose</summary>
      <pre id="dbg" style="white-space:pre-wrap;font-size:12px;line-height:1.3"></pre>
    </details>
  </div>

  <!-- Plan de consumo (diario) -->
  <div class="card">
    <div class="title">Plan de consumo (diario)</div>
    <div class="grid-3">
      <div class="kpi">
        <div class="l">Promedio diario Ah consumidos</div>
        <input id="consAvg" type="number" step="0.1" min="0" placeholder="p.ej., 53" style="margin-top:6px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa;color:var(--ink)"/>
      </div>
      <div class="kpi">
        <div class="l">Consumo adicional diario (Ah)</div>
        <input id="consExtra" type="number" step="0.1" min="0" placeholder="p.ej., 6.5" style="margin-top:6px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa;color:var(--ink)"/>
      </div>
      <div class="kpi">
        <div class="l">Balance diario (Ah)</div>
        <div id="kBal" class="v">‚Äì</div>
        <div class="muted" id="kBalNote" style="margin-top:4px"></div>
      </div>
    </div>
  </div>

  <!-- TRAMOS -->
  <div class="card" id="cardTramos">
    <div class="title">Tramos de consumo</div>
    <div class="muted">Horas sin decimales (0‚Äì24). Se calcula duraci√≥n, Wh y Ah con V<sub>chg</sub>. Cada tramo incluye +15% por p√©rdidas del inversor.</div>

    <label class="muted" style="display:flex;align-items:center;gap:8px;margin-top:6px">
      <input type="checkbox" id="syncAvg" checked>
      Usar el total de Ah de tramos (con 15% inversor) como ‚ÄúPromedio diario Ah consumidos‚Äù
    </label>

    <div id="trList"></div>

    <div class="seg" style="margin-top:8px">
      <button id="btnAddTr" class="btn secondary">A√±adir tramo</button>
      <button id="btnClearTr" class="btn secondary">Borrar todo</button>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="l">Total diario de tramos (incluye 15% inversor)</div>
      <div class="v"><span id="totWh">0</span> Wh ¬∑ <span id="totAh">0</span> Ah</div>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="l">Consumo del inversor (solo p√©rdidas, 15%)</div>
      <div class="v"><span id="invWh">0</span> Wh ¬∑ <span id="invAh">0</span> Ah</div>
    </div>
  </div>

  <!-- JSON de par√°metros -->
  <div class="card" id="cardJSON">
    <div class="title">Par√°metros (JSON)</div>
    <div class="muted">Se actualiza autom√°ticamente, se guarda internamente y puedes guardar/cargar archivo .json.</div>
    <textarea id="stateJson" rows="12" spellcheck="false" style="margin-top:8px"></textarea>
    <div class="seg" style="margin-top:8px">
      <button id="btnDownloadJson" class="btn secondary">Guardar archivo .json</button>
      <button id="btnOpenJson" class="btn secondary">Cargar archivo .json</button>
      <input id="fileOpen" type="file" accept="application/json,.json" style="display:none">
      <button id="btnClearStorage" class="btn secondary">Borrar guardado interno</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const modeSeg = $('#modeSeg');
  const cardRapido = $('#cardRapido');
  const cardDetallado = $('#cardDetallado');

  /* ===== util ===== */
  function valNum(id, def){ const v = parseFloat($(id).value); return isFinite(v)?v:def; }
  const LSKEY='rendFV_v1c_state';
  const FILENAME='Tendimiento te√≥ricoAh.json';

  // >>> Factor del inversor
  const INV_PCT = 0.15;         // 15% p√©rdidas
  const INV_FACTOR = 1 + INV_PCT;

  // Conmutar modo
  modeSeg.addEventListener('click', e=>{
    if(e.target.tagName!=='BUTTON') return;
    [...modeSeg.querySelectorAll('button')].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    const m = e.target.dataset.mode;
    cardRapido.style.display = (m==='rapido')?'block':'none';
    cardDetallado.style.display = (m==='detallado')?'block':'none';
    updateJSON();
  });

  // Steppers
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.step'); if(!btn) return;
    const target = document.querySelector(btn.dataset.t); if(!target) return;
    const d = parseFloat(btn.dataset.d||0);
    const step = parseFloat(target.step||'1') || 1;
    const val = parseFloat(target.value||'0') || 0;
    let next = val + d;
    if(target.min!==""){ next = Math.max(parseFloat(target.min), next); }
    if(target.max!==""){ next = Math.min(parseFloat(target.max), next); }
    const decimals = (step.toString().split('.')[1]||'').length;
    target.value = next.toFixed(decimals);
    if(target.id==='vChg'){ refreshAllRowMetrics(); updateTramosTotals(); }
    updateJSON();
  });

  // Curva solar y helpers de c√°lculo existentes
  const shape = [0.00,0.08,0.20,0.38,0.60,0.82,0.95,1.00,0.95,0.82,0.60,0.38,0.20,0.08,0.00];
  const sumShape = shape.reduce((a,b)=>a+b,0);
  function factorControl(Ipk, Ictrl){
    Ipk = Math.max(1e-6, Ipk);
    Ictrl = Math.max(1e-6, Ictrl);
    let adj=0;
    for(const w of shape){ adj += Math.min(w*Ipk, Ictrl); }
    return adj / (Ipk * sumShape);
  }

  let lastAh = 0, lastIpk = 0;

  function calc(){
    const nPanels = Math.max(0, Math.floor(valNum('#nPanels', 0)));
    const nBats   = Math.max(0, Math.floor(valNum('#nBats', 0)));
    const effPanel= Math.min(100, Math.max(0, valNum('#effPanel', 90)))/100;
    const effSys  = Math.min(100, Math.max(0, valNum('#effSys', 90)))/100;
    const vChg    = valNum('#vChg', 13.8);
    const tAmb    = valNum('#tAmb', 30);
    const ctrlA   = Math.max(1, Math.floor(valNum('#ctrlA', 30)));

    const Wp = nPanels * 60 * effPanel;

    const mRapido = modeSeg.querySelector('button.active').dataset.mode === 'rapido';
    let HSP = 5.0, fCielo=1.0;
    if(mRapido){
      const sky = $('#skyQuick').value;
      HSP = (sky==='soleado')?5.5:(sky==='parcial')?4.0:2.5;
    } else {
      const sky = $('#sky').value;
      const hum = $('#hum').value;
      const wind= $('#wind').value;
      const hspRef = valNum('#hspRef', 5.0);
      const mapSky = {despejado:1.00, parcial:0.85, mayormente:0.75, nublado:0.60, lluvia:0.40};
      const mapHum = {baja:1.00, media:0.98, alta:0.96, muyalta:0.94};
      const mapWind= {calma:1.00, leve:1.01, moderado:1.03};
      fCielo = (mapSky[sky]||1)*(mapHum[hum]||1)*(mapWind[wind]||1);
      HSP = hspRef;
    }

    const Tcell = tAmb + 20;
    const tempCoeff = -0.004;
    const fTemp = 1 + tempCoeff * (Tcell - 25);

    const Wh_ideal = Wp * HSP * fCielo * fTemp * effSys;
    const Ipk = Wp / Math.max(1, vChg);
    const fCtrl = factorControl(Ipk, ctrlA);
    const Wh = Wh_ideal * fCtrl;
    const Ah = Wh / Math.max(1, vChg);

    const bankAh = nBats * 18;
    const cov = bankAh>0 ? (Ah/bankAh*100) : 0;

    $('#kAh').textContent = Ah>0? Ah.toFixed(1): '0.0';
    $('#kIp').textContent = isFinite(Ipk)? Ipk.toFixed(1): '‚Äì';
    $('#kCap').textContent = bankAh.toFixed(0);
    $('#kCov').textContent = bankAh? cov.toFixed(0)+'%':'‚Äì';

    lastAh = Ah; lastIpk = Ipk;
    applyBalance();

    const dbg = {
      nPanels,nBats,Wp:+Wp.toFixed(1),effPanel,effSys,vChg,
      modo: (mRapido?'r√°pido':'detallado'),HSP,fCielo:+fCielo.toFixed(3),
      tAmb,Tcell,fTemp:+fTemp.toFixed(3),
      ctrlA, factorCtrl:+fCtrl.toFixed(3),
      IpkTheo:+Ipk.toFixed(2),
      Wh_ideal:+Wh_ideal.toFixed(1), Wh_ajustado:+Wh.toFixed(1)
    };
    $('#dbg').textContent = JSON.stringify(dbg, null, 2);

    refreshAllRowMetrics();
    updateTramosTotals();
    updateJSON();
  }

  function applyBalance(){
    const consAvg   = Math.max(0, valNum('#consAvg', 0));
    const consExtra = Math.max(0, valNum('#consExtra', 0));
    const need = consAvg + consExtra;
    const net = lastAh - need;

    if(!isFinite(net)){ $('#kBal').textContent='‚Äì'; $('#kBalNote').textContent=''; return; }

    const txt = Math.abs(net).toFixed(0) + ' Ah';
    if(net >= 0){
      $('#kBal').textContent = 'Sobran ' + txt;
      $('#kBal').classList.remove('bad'); $('#kBal').classList.add('good');
      $('#kBalNote').textContent = 'Tu generaci√≥n diaria cubre el consumo indicado.';
    }else{
      $('#kBal').textContent = 'Faltan ' + txt;
      $('#kBal').classList.remove('good'); $('#kBal').classList.add('bad');
      $('#kBalNote').textContent = 'Considera a√±adir paneles/bater√≠as o reducir consumo.';
    }
  }

  ['#consAvg','#consExtra','#vChg','#skyQuick','#sky','#hum','#wind','#hspRef']
  .forEach(sel=>{
    document.addEventListener('input', e=>{
      if(e.target.matches(sel)){
        if(sel==='#vChg'){ refreshAllRowMetrics(); updateTramosTotals(); }
        applyBalance(); updateJSON();
      }
    });
    document.addEventListener('change', e=>{
      if(e.target.matches(sel)){ applyBalance(); updateJSON(); }
    });
  });

  $('#btnCalc').addEventListener('click', calc);
  $('#btnReset').addEventListener('click', ()=>{
    const set=(id,val)=>{document.querySelector(id).value=val};
    set('#nPanels',2);set('#nBats',2);set('#effPanel',95);set('#effSys',90);
    set('#vChg','13.80');set('#tAmb','30');set('#hspRef','5.0');set('#ctrlA','30');
    $('#skyQuick').value='parcial';$('#sky').value='parcial';$('#hum').value='alta';$('#wind').value='leve';
    $('#kAh').textContent='‚Äì';$('#kIp').textContent='‚Äì';$('#kCap').textContent='‚Äì';$('#kCov').textContent='‚Äì';$('#dbg').textContent='';
    $('#consAvg').value=''; $('#consExtra').value=''; $('#kBal').textContent='‚Äì'; $('#kBal').classList.remove('good','bad'); $('#kBalNote').textContent='';
    lastAh = 0; lastIpk = 0;

    tramos = [];
    addTramo({start:0,end:24,watts:75});
    renderTramos(); refreshAllRowMetrics(); updateTramosTotals();
    $('#syncAvg').checked = true;
    updateJSON();
  });

  /* ===== Tramos de consumo ===== */
  const colors = ['#16a34a','#ea580c','#d97706','#059669','#2563eb','#9333ea','#0ea5e9','#f43f5e'];
  let tramos = [];

  function hoursOptions(selected){
    const opts = [];
    for(let h=0; h<=24; h++){
      opts.push(`<option value="${h}" ${h===selected?'selected':''}>${String(h).padStart(2,'0')}:00</option>`);
    }
    return opts.join('');
  }
  function labelFor(i){ return 'Tramo ' + String.fromCharCode(65+i); }
  function addTramo(init){ tramos.push(Object.assign({start:0,end:1,watts:10}, init||{})); }

  // Duraci√≥n y m√©tricas: devolvemos base y con p√©rdidas de inversor
  function tramoDur(t){ const s=Math.max(0,Math.min(24,t.start|0)); const e=Math.max(0,Math.min(24,t.end|0)); return (e>=s)?(e-s):(24-s)+e; }
  function tramoMetrics(t){
    const h = tramoDur(t);
    const whBase = (t.watts||0) * h;
    const v = valNum('#vChg',13.8);
    const ahBase = v>0 ? (whBase / v) : 0;
    const wh = whBase * INV_FACTOR;  // incluye 15%
    const ah = ahBase * INV_FACTOR;  // incluye 15%
    const invWh = whBase * INV_PCT;  // solo p√©rdidas
    const invAh = ahBase * INV_PCT;  // solo p√©rdidas
    return {h, whBase, ahBase, wh, ah, invWh, invAh};
  }

  function rowHTML(t, i){
    const {h, whBase, ahBase} = tramoMetrics(t);
    return `
      <div class="tr-hdr">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="dot" style="background:${colors[i%colors.length]}"></span>
          <strong>${labelFor(i)}</strong>
        </div>
        <button class="xbtn tr-del" title="Eliminar">‚úï</button>
      </div>
      <div class="tr-grid" style="align-items:center">
        <div>
          <label>Inicio</label>
          <select class="tr-start">${hoursOptions(t.start|0)}</select>
        </div>
        <div>
          <label>Fin</label>
          <select class="tr-end">${hoursOptions(t.end|0)}</select>
        </div>
        <div>
          <label>Potencia (W)</label>
          <input class="tr-watts" type="number" min="0" step="1" value="${t.watts||0}">
        </div>
        <div class="mini">
          <div><span class="icon">‚è±Ô∏è</span><b class="m-hours">${h}</b> h</div>
          <div><span class="icon">‚ö°</span><b class="m-wh">${Math.round(whBase)}</b> Wh</div>
          <div><span class="icon">üîã</span><b class="m-ah">${ahBase.toFixed(1)}</b> Ah</div>
        </div>
      </div>
    `;
  }
  function renderTramos(){
    const cont = $('#trList'); cont.innerHTML = '';
    tramos.forEach((t,i)=>{ const row=document.createElement('div'); row.className='tr-row'; row.dataset.idx=i; row.innerHTML=rowHTML(t,i); cont.appendChild(row); });
  }
  function updateRowMetrics(row,i){
    const m=tramoMetrics(tramos[i]);
    row.querySelector('.m-hours').textContent=m.h;
    row.querySelector('.m-wh').textContent=Math.round(m.whBase);
    row.querySelector('.m-ah').textContent=m.ahBase.toFixed(1);
  }
  function refreshAllRowMetrics(){ document.querySelectorAll('.tr-row').forEach(row=>{ const i=+row.dataset.idx; updateRowMetrics(row,i); }); }

  function updateTramosTotals(){
    let Twh=0, Tah=0, Iwh=0, Iah=0;
    tramos.forEach(t=>{ const m=tramoMetrics(t); Twh+=m.wh; Tah+=m.ah; Iwh+=m.invWh; Iah+=m.invAh; });
    $('#totWh').textContent = Math.round(Twh);
    $('#totAh').textContent = Tah.toFixed(1);
    $('#invWh').textContent = Math.round(Iwh);
    $('#invAh').textContent = Iah.toFixed(1);

    // Sincroniza con Promedio diario si est√° activado (usa Ah con 15%)
    const sync = $('#syncAvg').checked; const avgField = $('#consAvg');
    if(sync){ avgField.value = Tah.toFixed(1); avgField.setAttribute('readonly','readonly'); } else { avgField.removeAttribute('readonly'); }
    applyBalance(); updateJSON();
  }

  // Delegaci√≥n
  document.addEventListener('input', e=>{
    const row = e.target.closest('.tr-row'); 
    if(row){
      const i = +row.dataset.idx;
      if(e.target.classList.contains('tr-watts')){
        tramos[i].watts = parseFloat(e.target.value)||0;
        updateRowMetrics(row,i); updateTramosTotals();
      }
      return;
    }
  });
  document.addEventListener('change', e=>{
    if(e.target.id==='syncAvg'){ updateTramosTotals(); return; }
    const row = e.target.closest('.tr-row'); if(!row) return;
    const i = +row.dataset.idx;
    if(e.target.classList.contains('tr-start')){ tramos[i].start = parseInt(e.target.value)||0; }
    if(e.target.classList.contains('tr-end'))  { tramos[i].end   = parseInt(e.target.value)||0; }
    updateRowMetrics(row,i); updateTramosTotals();
  });
  document.addEventListener('click', e=>{
    if(e.target.closest('.tr-del')){
      const row = e.target.closest('.tr-row'); const i = +row.dataset.idx;
      tramos.splice(i,1); renderTramos(); refreshAllRowMetrics(); updateTramosTotals();
    }
  });
  $('#btnAddTr').addEventListener('click', ()=>{ addTramo({start:0,end:1,watts:10}); renderTramos(); refreshAllRowMetrics(); updateTramosTotals(); });
  $('#btnClearTr').addEventListener('click', ()=>{ tramos = []; renderTramos(); updateTramosTotals(); });

  /* ===== JSON: construir, auto-guardar y archivo ===== */
  function buildState(){
    const m = modeSeg.querySelector('button.active').dataset.mode;
    return {
      system:{
        nPanels:+$('#nPanels').value||0, nBats:+$('#nBats').value||0,
        effPanel:+$('#effPanel').value||0, effSys:+$('#effSys').value||0,
        vChg:+$('#vChg').value||0, tAmb:+$('#tAmb').value||0, ctrlA:+$('#ctrlA').value||0
      },
      mode:m,
      climate:(m==='rapido')?{skyQuick:$('#skyQuick').value}:{sky:$('#sky').value,hum:$('#hum').value,wind:$('#wind').value,hspRef:+$('#hspRef').value||0},
      lastCalc:{Ah:+($('#kAh').textContent)||0, Ipk:lastIpk||0},
      consumo:{consAvg:+$('#consAvg').value||0, consExtra:+$('#consExtra').value||0, balance:$('#kBal').textContent.trim()},
      tramos: tramos.map(t=>({start:t.start,end:t.end,watts:t.watts})),
      totalesTramos:{
        Wh:+$('#totWh').textContent||0,
        Ah:+$('#totAh').textContent||0,
        inversor:{Wh:+$('#invWh').textContent||0, Ah:+$('#invAh').textContent||0}
      },
      opciones:{syncPromedio: $('#syncAvg').checked, factorInversor: INV_PCT}
    };
  }
  function updateJSON(){
    const text = JSON.stringify(buildState(), null, 2);
    $('#stateJson').value = text;
    localStorage.setItem(LSKEY, text);
  }

  function loadStateObject(s){
    try{
      const set=(id,v)=>{ const el=$(id); if(el!=null && v!=null) el.value=v; };
      if(s.system){ set('#nPanels',s.system.nPanels); set('#nBats',s.system.nBats); set('#effPanel',s.system.effPanel);
                    set('#effSys',s.system.effSys); set('#vChg',s.system.vChg); set('#tAmb',s.system.tAmb); set('#ctrlA',s.system.ctrlA); }
      if(s.mode==='rapido'){ modeSeg.querySelector('[data-mode="rapido"]').click(); if(s.climate&&s.climate.skyQuick) $('#skyQuick').value=s.climate.skyQuick; }
      if(s.mode==='detallado'){ modeSeg.querySelector('[data-mode="detallado"]').click(); if(s.climate){ $('#sky').value=s.climate.sky||'parcial'; $('#hum').value=s.climate.hum||'media'; $('#wind').value=s.climate.wind||'leve'; if(s.climate.hspRef!=null) $('#hspRef').value=s.climate.hspRef; } }
      if(s.consumo){ set('#consAvg',s.consumo.consAvg); set('#consExtra',s.consumo.consExtra); }
      if(s.opciones){ $('#syncAvg').checked = !!s.opciones.syncPromedio; }
      if(Array.isArray(s.tramos)){ tramos = s.tramos.map(t=>({start:+t.start||0,end:+t.end||0,watts:+t.watts||0})); } else { tramos=[]; }
      renderTramos(); refreshAllRowMetrics(); updateTramosTotals(); applyBalance(); updateJSON();
    }catch(e){}
  }

  // Guardar a archivo .json
  $('#btnDownloadJson').addEventListener('click', ()=>{
    const blob = new Blob([$('#stateJson').value], {type:'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = FILENAME;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  });

  // Cargar desde archivo .json
  $('#btnOpenJson').addEventListener('click', ()=>$('#fileOpen').click());
  $('#fileOpen').addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    try{
      const text = await f.text();
      const s = JSON.parse(text);
      loadStateObject(s);
      localStorage.setItem(LSKEY, JSON.stringify(s));
    }catch(err){}
    e.target.value = '';
  });

  // Borrar guardado interno
  $('#btnClearStorage').addEventListener('click', ()=>{ localStorage.removeItem(LSKEY); });

  // Inicial
  addTramo({start:0,end:24,watts:75});
  renderTramos(); refreshAllRowMetrics(); updateTramosTotals();
  // Carga previa si existe
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){ loadStateObject(JSON.parse(raw)); }
    else{ updateJSON(); }
  }catch(e){ updateJSON(); }
})();
</script>
</body>
</html>