<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Extracci√≥n de Espresso</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6B4423 0%, #3E2723 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .timer-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
        }
        
        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .timer-phase {
            font-size: 1.2em;
            color: #6B4423;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .timer-count {
            font-size: 4em;
            font-weight: bold;
            color: #3E2723;
            margin: 10px 0;
        }
        
        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .save-indicator {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #4CAF50;
            min-height: 20px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .btn-start:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-stop {
            background: #f44336;
            color: white;
        }
        
        .btn-stop:hover {
            background: #da190b;
            transform: translateY(-2px);
        }
        
        .btn-add {
            background: #2196F3;
            color: white;
        }
        
        .btn-add:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        .data-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-export-all, .btn-import-all, .btn-clear-all {
            padding: 10px 20px;
            font-size: 0.95em;
        }
        
        .btn-export-all {
            background: #9C27B0;
            color: white;
        }
        
        .btn-import-all {
            background: #673AB7;
            color: white;
        }
        
        .btn-clear-all {
            background: #FF5722;
            color: white;
        }
        
        .cards-container {
            overflow-x: auto;
            white-space: nowrap;
            padding: 20px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .cards-wrapper {
            display: inline-flex;
            gap: 20px;
        }
        
        .extraction-card {
            display: inline-block;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            width: 350px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
            white-space: normal;
            vertical-align: top;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-number {
            font-size: 0.9em;
            color: #6B4423;
            font-weight: bold;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }
        
        .image-upload {
            width: 100%;
            height: 250px;
            border: 3px dashed #6B4423;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
            overflow: hidden;
            background: #f5f5f5;
            position: relative;
        }
        
        .image-upload img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .upload-placeholder {
            text-align: center;
            color: #6B4423;
        }
        
        .upload-placeholder svg {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        textarea:focus {
            outline: none;
            border-color: #6B4423;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            
            .timer-count {
                font-size: 3em;
            }
            
            button {
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .extraction-card {
                width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚òï Control de Extracci√≥n de Espresso</h1>
        
        <div class="timer-card">
            <div class="timer-display">
                <div class="timer-phase" id="phase">Listo para comenzar</div>
                <div class="timer-count" id="count">--</div>
            </div>
            <div class="timer-controls">
                <button class="btn-start" id="startBtn" onclick="startTimer()">‚ñ∂ Iniciar Extracci√≥n</button>
                <button class="btn-stop" id="stopBtn" onclick="stopTimer()" style="display:none;">‚èπ Detener</button>
                <button class="btn-add" onclick="addCard()">‚ûï Agregar Tarjeta</button>
            </div>
            <div class="data-controls">
                <button class="btn-export-all" onclick="exportAllCards()">‚¨á Exportar Todas</button>
                <button class="btn-import-all" onclick="document.getElementById('importAll').click()">‚¨Ü Importar Todas</button>
                <button class="btn-clear-all" onclick="clearAllData()">üóëÔ∏è Borrar Todo</button>
                <input type="file" id="importAll" accept=".json" onchange="importAllCards(event)" style="display:none;">
            </div>
            <div class="save-indicator" id="saveIndicator"></div>
        </div>
        
        <div class="cards-container">
            <div class="cards-wrapper" id="cardsWrapper">
                <!-- Las tarjetas se generar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        let timerInterval = null;
        let currentPhase = 0;
        let currentCount = 0;
        let cards = [];
        
        const phases = [
            { name: "Preparaci√≥n", duration: 5, countTo: 0, announce: false },
            { name: "Pre-infusi√≥n", duration: 8, countTo: 8, announce: true },
            { name: "Transici√≥n", duration: 3, countTo: 3, announce: true },
            { name: "Extracci√≥n Principal", duration: 25, countTo: 25, announce: true }
        ];
        
        // Comprimir imagen antes de guardar
        function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        // Guardar en localStorage
        function saveToLocalStorage() {
            try {
                const data = {
                    cards: cards,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('espressoExtractions', JSON.stringify(data));
                showSaveIndicator('‚úì Guardado autom√°ticamente');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showSaveIndicator('‚ö†Ô∏è Memoria llena. Exporta y borra datos antiguos.');
                } else {
                    showSaveIndicator('‚úó Error al guardar');
                }
            }
        }
        
        // Cargar desde localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('espressoExtractions');
                if (saved) {
                    const data = JSON.parse(saved);
                    return data.cards || [];
                }
            } catch (e) {
                console.error('Error al cargar datos:', e);
            }
            return [];
        }
        
        function showSaveIndicator(message) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            setTimeout(() => {
                indicator.textContent = '';
            }, 3000);
        }
        
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speechSynthesis.speak(utterance);
            }
        }
        
        function startTimer() {
            if (timerInterval) return;
            
            currentPhase = 0;
            currentCount = 0;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            runPhase();
        }
        
        function runPhase() {
            if (currentPhase >= phases.length) {
                finishTimer();
                return;
            }
            
            const phase = phases[currentPhase];
            document.getElementById('phase').textContent = phase.name;
            
            if (phase.announce) {
                currentCount = 1;
                document.getElementById('count').textContent = currentCount;
                speak(currentCount.toString());
                
                timerInterval = setInterval(() => {
                    currentCount++;
                    if (currentCount <= phase.countTo) {
                        document.getElementById('count').textContent = currentCount;
                        speak(currentCount.toString());
                    }
                    
                    if (currentCount >= phase.countTo) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        currentPhase++;
                        setTimeout(runPhase, 1000);
                    }
                }, 1000);
            } else {
                currentCount = 5;
                document.getElementById('count').textContent = currentCount;
                
                timerInterval = setInterval(() => {
                    currentCount--;
                    document.getElementById('count').textContent = currentCount;
                    
                    if (currentCount <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        currentPhase++;
                        runPhase();
                    }
                }, 1000);
            }
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            speechSynthesis.cancel();
            
            document.getElementById('phase').textContent = 'Detenido';
            document.getElementById('count').textContent = '--';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }
        
        function finishTimer() {
            document.getElementById('phase').textContent = '¬°Extracci√≥n Completa!';
            document.getElementById('count').textContent = '‚úì';
            speak('Extracci√≥n completa');
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }
        
        function createCard(cardData = null) {
            const id = cardData ? cardData.id : Date.now();
            const card = cardData || {
                id: id,
                image: null,
                notes: '',
                timestamp: new Date().toISOString()
            };
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'extraction-card';
            cardDiv.id = `card-${card.id}`;
            
            const cardIndex = cards.length;
            
            cardDiv.innerHTML = `
                <div class="card-header">
                    <div class="card-number">Extracci√≥n #${cardIndex + 1}</div>
                    <button class="btn-delete" onclick="deleteCard(${card.id})">üóëÔ∏è Eliminar</button>
                </div>
                <div class="image-upload" onclick="document.getElementById('file-${card.id}').click()">
                    ${card.image ? `<img src="${card.image}" alt="Espresso">` : `
                    <div class="upload-placeholder">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <div>Subir foto</div>
                    </div>`}
                </div>
                <input type="file" id="file-${card.id}" accept="image/*" onchange="handleImageUpload(event, ${card.id})">
                <textarea id="notes-${card.id}" placeholder="Detalles de la extracci√≥n y comentarios..." oninput="autoSaveCard(${card.id})">${card.notes}</textarea>
            `;
            
            return { card, element: cardDiv };
        }
        
        async function handleImageUpload(event, cardId) {
            const file = event.target.files[0];
            if (!file) return;
            
            showSaveIndicator('‚è≥ Comprimiendo imagen...');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const compressed = await compressImage(e.target.result);
                    
                    const cardIndex = cards.findIndex(c => c.id === cardId);
                    if (cardIndex !== -1) {
                        cards[cardIndex].image = compressed;
                        
                        const uploadDiv = event.target.previousElementSibling;
                        uploadDiv.innerHTML = `<img src="${compressed}" alt="Espresso">`;
                        
                        saveToLocalStorage();
                    }
                } catch (error) {
                    showSaveIndicator('‚úó Error al procesar imagen');
                }
            };
            reader.readAsDataURL(file);
        }
        
        function autoSaveCard(cardId) {
            const cardIndex = cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                const notes = document.getElementById(`notes-${cardId}`).value;
                cards[cardIndex].notes = notes;
                saveToLocalStorage();
            }
        }
        
        function deleteCard(cardId) {
            if (!confirm('¬øEliminar esta tarjeta?')) return;
            
            const cardIndex = cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                cards.splice(cardIndex, 1);
                document.getElementById(`card-${cardId}`).remove();
                saveToLocalStorage();
                renderAllCards();
            }
        }
        
        function exportAllCards() {
            const dataStr = JSON.stringify({
                cards: cards,
                exportDate: new Date().toISOString(),
                totalCards: cards.length
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `espresso-extracciones-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSaveIndicator('‚úì Exportado correctamente');
        }
        
        function importAllCards(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.cards && Array.isArray(data.cards)) {
                        if (confirm(`¬øImportar ${data.cards.length} tarjetas? Esto reemplazar√° todas las tarjetas actuales.`)) {
                            cards = data.cards;
                            saveToLocalStorage();
                            renderAllCards();
                            showSaveIndicator(`‚úì Importadas ${data.cards.length} tarjetas`);
                        }
                    } else {
                        showSaveIndicator('‚úó Archivo JSON inv√°lido');
                    }
                } catch (error) {
                    showSaveIndicator('‚úó Error al importar');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('¬øBORRAR TODAS las tarjetas y datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('¬øEst√°s completamente seguro? Se perder√°n todas tus extracciones.')) {
                    cards = [];
                    localStorage.removeItem('espressoExtractions');
                    renderAllCards();
                    showSaveIndicator('‚úì Todos los datos borrados');
                }
            }
        }
        
        function addCard() {
            const newCardData = createCard();
            cards.push(newCardData.card);
            document.getElementById('cardsWrapper').appendChild(newCardData.element);
            saveToLocalStorage();
        }
        
        function renderAllCards() {
            const wrapper = document.getElementById('cardsWrapper');
            wrapper.innerHTML = '';
            
            cards.forEach((cardData) => {
                const cardElement = createCard(cardData);
                wrapper.appendChild(cardElement.element);
            });
        }
        
        // Inicializar
        function init() {
            const savedCards = loadFromLocalStorage();
            
            if (savedCards.length > 0) {
                cards = savedCards;
                renderAllCards();
                showSaveIndicator(`‚úì Cargadas ${savedCards.length} tarjetas`);
            } else {
                // Crear 10 tarjetas iniciales solo si no hay datos guardados
                for (let i = 0; i < 10; i++) {
                    const newCardData = createCard();
                    cards.push(newCardData.card);
                }
                renderAllCards();
                saveToLocalStorage();
            }
        }
        
        init();
    </script>
</body>
</html>