<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Extracci√≥n de Espresso v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6B4423 0%, #3E2723 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        /* Forzar opacidad completa en todas las tarjetas y sus elementos */
        .extraction-card,
        .extraction-card *,
        .timer-card,
        .timer-card *,
        .controls-card,
        .controls-card * {
            opacity: 1 !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .timer-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
        }
        
        .controls-card {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .controls-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .controls-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #6B4423;
        }
        
        .collapse-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            color: #6B4423;
        }
        
        .collapse-icon.open {
            transform: rotate(180deg);
        }
        
        .controls-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .controls-content.open {
            max-height: 300px;
            margin-top: 15px;
        }
        
        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .timer-phase {
            font-size: 1.2em;
            color: #6B4423;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .timer-count {
            font-size: 4em;
            font-weight: bold;
            color: #3E2723;
            margin: 10px 0;
        }
        
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .save-indicator {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #4CAF50;
            min-height: 20px;
        }
        
        .debug-info {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85em;
            color: #FF5722;
            min-height: 20px;
            font-weight: bold;
            padding: 5px;
            background: rgba(255, 87, 34, 0.1);
            border-radius: 5px;
        }
        
        button {
            padding: 12px 20px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-timer {
            padding: 15px 30px;
            font-size: 1.1em;
        }
        
        .btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .btn-start:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-stop {
            background: #f44336;
            color: white;
        }
        
        .btn-stop:hover {
            background: #da190b;
            transform: translateY(-2px);
        }
        
        .btn-add {
            background: #2196F3;
            color: white;
        }
        
        .btn-add:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        .btn-export-all {
            background: #9C27B0;
            color: white;
        }
        
        .btn-export-all:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }
        
        .btn-import-all {
            background: #673AB7;
            color: white;
        }
        
        .btn-import-all:hover {
            background: #512DA8;
            transform: translateY(-2px);
        }
        
        .btn-clear-all {
            background: #FF5722;
            color: white;
        }
        
        .btn-clear-all:hover {
            background: #E64A19;
            transform: translateY(-2px);
        }
        
        .cards-container {
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 20px 0;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .cards-container::-webkit-scrollbar {
            display: none;
        }
        
        .cards-wrapper {
            display: inline-flex;
            gap: 20px;
            padding: 0 calc(50vw - 175px);
        }
        
        .extraction-card {
            display: inline-block;
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 350px;
            min-width: 350px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
            white-space: normal;
            vertical-align: top;
        }
        
        .extraction-card img {
            opacity: 1 !important;
        }
        
        .extraction-card textarea {
            opacity: 1 !important;
            color: #333 !important;
        }
        
        .card-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .nav-button {
            background: rgba(255, 255, 255, 0.9);
            color: #6B4423;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            border: 2px solid #6B4423;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .nav-button:hover {
            background: #6B4423;
            color: white;
        }
        
        .card-indicator {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .extraction-card {
            display: block;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            min-width: 350px;
            max-width: 350px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            color: #333;
            white-space: normal;
            flex-shrink: 0;
            opacity: 0.3;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        
        .extraction-card.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-number {
            font-size: 0.9em;
            color: #6B4423;
            font-weight: bold;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }
        
        .image-upload {
            width: 100%;
            height: 250px;
            border: 3px dashed #6B4423;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
            overflow: hidden;
            background: #f5f5f5;
            position: relative;
        }
        
        .image-upload img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            opacity: 1 !important;
            filter: none !important;
        }
        
        .upload-placeholder {
            text-align: center;
            color: #6B4423;
        }
        
        .upload-placeholder svg {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            margin-bottom: 15px;
            background: white !important;
            color: #333 !important;
            opacity: 1 !important;
        }
        
        textarea:focus {
            outline: none;
            border-color: #6B4423;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            
            .timer-count {
                font-size: 3em;
            }
            
            button {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            .btn-timer {
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .extraction-card {
                width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚òï Control de Extracci√≥n de Espresso</h1>
        
        <div class="timer-card">
            <div class="timer-display">
                <div class="timer-phase" id="phase">Listo para comenzar</div>
                <div class="timer-count" id="count">--</div>
            </div>
            <div class="timer-controls">
                <button class="btn-start btn-timer" id="startBtn" onclick="startTimer()">‚ñ∂ Iniciar Extracci√≥n</button>
                <button class="btn-stop btn-timer" id="stopBtn" onclick="stopTimer()" style="display:none;">‚èπ Detener</button>
            </div>
            <div class="debug-info" id="debugInfo">Sistema listo - v2.0</div>
            <div class="save-indicator" id="saveIndicator"></div>
        </div>
        
        <div class="controls-card" onclick="toggleControls()">
            <div class="controls-header">
                <div class="controls-title">‚öôÔ∏è Administraci√≥n</div>
                <div class="collapse-icon" id="collapseIcon">‚ñº</div>
            </div>
            <div class="controls-content" id="controlsContent" onclick="event.stopPropagation()">
                <div class="controls-grid">
                    <button class="btn-add" onclick="addCard()">‚ûï Agregar Tarjeta</button>
                    <button class="btn-export-all" onclick="exportAllCards()">‚¨á Exportar Todas</button>
                    <button class="btn-import-all" onclick="document.getElementById('importAll').click()">‚¨Ü Importar Todas</button>
                    <button class="btn-clear-all" onclick="clearAllData()">üóëÔ∏è Borrar Todo</button>
                </div>
                <input type="file" id="importAll" accept=".json" onchange="importAllCards(event)" style="display:none;">
            </div>
        </div>
        
        <div class="cards-container" id="cardsContainer">
            <div class="cards-wrapper" id="cardsWrapper">
                <!-- Las tarjetas se generar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        // VERSI√ìN 2.0 - REESCRITURA COMPLETA
        let timerInterval = null;
        let currentPhase = 0;
        let currentCount = 0;
        let cards = [];
        
        // DEFINICI√ìN DE FASES
        const TIMER_PHASES = [
            { name: "Preparaci√≥n", seconds: 5, mode: "countdown_silent" },
            { name: "Precalentamiento", seconds: 15, mode: "countdown_voice" },
            { name: "Pre-infusi√≥n", seconds: 8, mode: "countup_voice" },
            { name: "Transici√≥n", seconds: 3, mode: "countup_voice" },
            { name: "Extracci√≥n Principal", seconds: 25, mode: "countup_voice" }
        ];
        
        function playBeep() {
            showDebug('üîî BEEP');
            // Crear un beep usando Web Audio API
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                const AudioContextClass = AudioContext || webkitAudioContext;
                const audioCtx = new AudioContextClass();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800; // Frecuencia del beep
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }
        
        function showDebug(msg) {
            const el = document.getElementById('debugInfo');
            if (el) el.textContent = msg;
        }
        
        function speakText(text) {
            showDebug('üîä Diciendo: ' + text);
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                setTimeout(() => {
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'es-ES';
                    u.rate = 1.0;
                    u.volume = 1.0;
                    speechSynthesis.speak(u);
                }, 100);
            }
        }
        
        function startTimer() {
            if (timerInterval) return;
            currentPhase = 0;
            currentCount = 0;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            executePhase();
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            speechSynthesis.cancel();
            document.getElementById('phase').textContent = 'Detenido';
            document.getElementById('count').textContent = '--';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            showDebug('Timer detenido');
        }
        
        function executePhase() {
            if (currentPhase >= TIMER_PHASES.length) {
                finishTimer();
                return;
            }
            
            const phase = TIMER_PHASES[currentPhase];
            document.getElementById('phase').textContent = phase.name;
            showDebug(`FASE ${currentPhase + 1}: ${phase.name} - ${phase.seconds}s - Modo: ${phase.mode}`);
            
            if (phase.mode === "countdown_silent") {
                // Preparaci√≥n: cuenta regresiva silenciosa
                currentCount = phase.seconds;
                document.getElementById('count').textContent = currentCount;
                
                timerInterval = setInterval(() => {
                    currentCount--;
                    document.getElementById('count').textContent = currentCount;
                    if (currentCount <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        currentPhase++;
                        executePhase();
                    }
                }, 1000);
                
            } else if (phase.mode === "countdown_voice") {
                // Precalentamiento: cuenta regresiva con voz al inicio y fin
                speakText(`Precalentamiento de ${phase.seconds} segundos iniciando`);
                currentCount = phase.seconds;
                document.getElementById('count').textContent = currentCount;
                
                timerInterval = setInterval(() => {
                    currentCount--;
                    document.getElementById('count').textContent = currentCount;
                    showDebug(`Precalentamiento: ${currentCount}s restantes`);
                    
                    if (currentCount <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        speakText('Precalentamiento finalizado');
                        setTimeout(() => {
                            currentPhase++;
                            executePhase();
                        }, 2000);
                    }
                }, 1000);
                
            } else if (phase.mode === "countup_voice") {
                // Pre-infusi√≥n, transici√≥n, extracci√≥n: cuenta ascendente con voz
                
                currentCount = 1;
                document.getElementById('count').textContent = currentCount;
                speakText(currentCount.toString());
                
                timerInterval = setInterval(() => {
                    currentCount++;
                    document.getElementById('count').textContent = currentCount;
                    speakText(currentCount.toString());
                    
                    // Beep en segundo 17 de extracci√≥n principal
                    if (phase.name === "Extracci√≥n Principal" && currentCount === 17) {
                        setTimeout(() => {
                            playBeep();
                        }, 500);
                    }
                    
                    if (currentCount >= phase.seconds) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        currentPhase++;
                        setTimeout(executePhase, 1000);
                    }
                }, 1000);
            }
        }
        
        function finishTimer() {
            document.getElementById('phase').textContent = '¬°Extracci√≥n Completa!';
            document.getElementById('count').textContent = '‚úì';
            speakText('Extracci√≥n completa');
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            showDebug('‚úì Proceso completado');
        }
        
        // FUNCIONES DE TARJETAS
        function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        function saveToLocalStorage() {
            try {
                const data = {
                    cards: cards,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('espressoExtractions', JSON.stringify(data));
                showSaveIndicator('‚úì Guardado autom√°ticamente');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showSaveIndicator('‚ö†Ô∏è Memoria llena. Exporta y borra datos antiguos.');
                } else {
                    showSaveIndicator('‚úó Error al guardar');
                }
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('espressoExtractions');
                if (saved) {
                    const data = JSON.parse(saved);
                    return data.cards || [];
                }
            } catch (e) {
                console.error('Error al cargar datos:', e);
            }
            return [];
        }
        
        function showSaveIndicator(message) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            setTimeout(() => {
                indicator.textContent = '';
            }, 3000);
        }
        
        function createCard(cardData = null, cardIndex = null, uniqueId = null) {
            const id = cardData ? cardData.id : Date.now();
            const displayId = uniqueId || id; // ID √∫nico para el DOM
            
            let initialNotes = '';
            if (!cardData) {
                const now = new Date();
                const ecuadorDate = new Intl.DateTimeFormat('es-EC', {
                    timeZone: 'America/Guayaquil',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(now);
                initialNotes = `${ecuadorDate}\n`;
            }
            
            const card = cardData || {
                id: id,
                image: null,
                notes: initialNotes,
                timestamp: new Date().toISOString()
            };
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'extraction-card';
            cardDiv.id = `card-${displayId}`;
            cardDiv.dataset.cardId = id; // ID real de la tarjeta
            
            const displayIndex = cardIndex !== null ? cardIndex : cards.findIndex(c => c.id === card.id);
            
            cardDiv.innerHTML = `
                <div class="card-header">
                    <div class="card-number" id="cardnum-${displayId}">Extracci√≥n #${displayIndex + 1}</div>
                    <button class="btn-delete" onclick="deleteCard(${id})">üóëÔ∏è Eliminar</button>
                </div>
                <div class="image-upload" onclick="document.getElementById('file-${displayId}').click()">
                    ${card.image ? `<img src="${card.image}" alt="Espresso" style="opacity: 1;">` : `
                    <div class="upload-placeholder">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <div>Subir foto</div>
                    </div>`}
                </div>
                <input type="file" id="file-${displayId}" accept="image/*" onchange="handleImageUpload(event, ${id}, '${displayId}')">
                <textarea id="notes-${displayId}" placeholder="Detalles de la extracci√≥n y comentarios..." oninput="autoSaveCard(${id}, '${displayId}')" style="opacity: 1; color: #333;">${card.notes}</textarea>
            `;
            
            return { card, element: cardDiv };
        }
        
        async function handleImageUpload(event, cardId, displayId) {
            const file = event.target.files[0];
            if (!file) return;
            
            showSaveIndicator('‚è≥ Comprimiendo imagen...');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const compressed = await compressImage(e.target.result);
                    
                    const cardIndex = cards.findIndex(c => c.id === cardId);
                    if (cardIndex !== -1) {
                        cards[cardIndex].image = compressed;
                        
                        // Actualizar TODAS las copias de esta tarjeta
                        const allCardCopies = document.querySelectorAll(`[data-card-id="${cardId}"]`);
                        allCardCopies.forEach(cardElement => {
                            const uploadDiv = cardElement.querySelector('.image-upload');
                            if (uploadDiv) {
                                uploadDiv.innerHTML = `<img src="${compressed}" alt="Espresso" style="opacity: 1;">`;
                            }
                        });
                        
                        saveToLocalStorage();
                    }
                } catch (error) {
                    showSaveIndicator('‚úó Error al procesar imagen');
                }
            };
            reader.readAsDataURL(file);
        }
        
        function autoSaveCard(cardId, displayId) {
            const cardIndex = cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                const notes = document.getElementById(`notes-${displayId}`).value;
                cards[cardIndex].notes = notes;
                
                // Sincronizar el texto en todas las copias de esta tarjeta
                const allCardCopies = document.querySelectorAll(`[data-card-id="${cardId}"]`);
                allCardCopies.forEach(cardElement => {
                    const textarea = cardElement.querySelector('textarea');
                    if (textarea && textarea.id !== `notes-${displayId}`) {
                        textarea.value = notes;
                    }
                });
                
                saveToLocalStorage();
            }
        }
        
        function deleteCard(cardId) {
            if (!confirm('¬øEliminar esta tarjeta?')) return;
            
            const cardIndex = cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                cards.splice(cardIndex, 1);
                saveToLocalStorage();
                renderAllCards();
            }
        }
        
        function exportAllCards() {
            const dataStr = JSON.stringify({
                cards: cards,
                exportDate: new Date().toISOString(),
                totalCards: cards.length
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `espresso-extracciones-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSaveIndicator('‚úì Exportado correctamente');
        }
        
        function importAllCards(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.cards && Array.isArray(data.cards)) {
                        if (confirm(`¬øImportar ${data.cards.length} tarjetas? Esto reemplazar√° todas las tarjetas actuales.`)) {
                            cards = data.cards;
                            saveToLocalStorage();
                            renderAllCards();
                            showSaveIndicator(`‚úì Importadas ${data.cards.length} tarjetas`);
                        }
                    } else {
                        showSaveIndicator('‚úó Archivo JSON inv√°lido');
                    }
                } catch (error) {
                    showSaveIndicator('‚úó Error al importar');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('¬øBORRAR TODAS las tarjetas y datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('¬øEst√°s completamente seguro? Se perder√°n todas tus extracciones.')) {
                    cards = [];
                    localStorage.removeItem('espressoExtractions');
                    renderAllCards();
                    showSaveIndicator('‚úì Todos los datos borrados');
                }
            }
        }
        
        function toggleControls() {
            const content = document.getElementById('controlsContent');
            const icon = document.getElementById('collapseIcon');
            
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }
        
        function addCard() {
            const newCardData = createCard(null, cards.length);
            cards.push(newCardData.card);
            saveToLocalStorage();
            
            // Re-renderizar todas las tarjetas (con las 3 copias)
            renderAllCards();
            
            // Scroll autom√°tico a la nueva tarjeta en el grupo del medio
            setTimeout(() => {
                const container = document.getElementById('cardsContainer');
                const cardWidth = 370;
                const middleGroupStart = cards.length * cardWidth;
                const newCardPosition = middleGroupStart + ((cards.length - 1) * cardWidth);
                container.scrollLeft = newCardPosition;
            }, 100);
        }
        
        function renderAllCards() {
            const wrapper = document.getElementById('cardsWrapper');
            wrapper.innerHTML = '';
            
            // Crear 3 copias de las tarjetas con IDs √∫nicos para evitar conflictos
            for (let copy = 0; copy < 3; copy++) {
                cards.forEach((cardData, index) => {
                    const uniqueId = `${cardData.id}-copy${copy}`;
                    const cardElement = createCard(cardData, index, uniqueId);
                    wrapper.appendChild(cardElement.element);
                });
            }
        }
        
        function init() {
            const savedCards = loadFromLocalStorage();
            
            if (savedCards.length > 0) {
                cards = savedCards;
            } else {
                for (let i = 0; i < 10; i++) {
                    const newCardData = createCard();
                    cards.push(newCardData.card);
                }
                saveToLocalStorage();
            }
            
            renderAllCards();
            
            if (savedCards.length > 0) {
                showSaveIndicator(`‚úì Cargadas ${savedCards.length} tarjetas`);
            }
            
            // Scroll inicial: posicionar en el segundo grupo (originales)
            setTimeout(() => {
                const container = document.getElementById('cardsContainer');
                const cardWidth = 370; // 350 + 20 gap
                const middlePosition = cards.length * cardWidth;
                container.scrollLeft = middlePosition + (container.scrollWidth - container.clientWidth) / 2;
            }, 500);
            
            // Scroll infinito: detectar cuando llega a los extremos
            const container = document.getElementById('cardsContainer');
            let isScrolling = false;
            
            container.addEventListener('scroll', () => {
                if (isScrolling) return;
                
                const scrollLeft = container.scrollLeft;
                const scrollWidth = container.scrollWidth;
                const clientWidth = container.clientWidth;
                const cardWidth = 370;
                const totalCards = cards.length;
                
                // Posici√≥n del primer grupo (izquierda)
                const firstGroupEnd = cardWidth * totalCards;
                // Posici√≥n del tercer grupo (derecha)
                const thirdGroupStart = cardWidth * totalCards * 2;
                
                // Si lleg√≥ al inicio del primer grupo, saltar al segundo
                if (scrollLeft < firstGroupEnd / 2) {
                    isScrolling = true;
                    container.scrollLeft = scrollLeft + (cardWidth * totalCards);
                    setTimeout(() => { isScrolling = false; }, 100);
                }
                
                // Si lleg√≥ al inicio del tercer grupo, saltar al segundo
                if (scrollLeft > thirdGroupStart) {
                    isScrolling = true;
                    container.scrollLeft = scrollLeft - (cardWidth * totalCards);
                    setTimeout(() => { isScrolling = false; }, 100);
                }
            });
        }
        
        init();
    </script>
</body>
</html>